<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raashanmart - Shopkeeper Panel</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3082/3082383.png" type="image/x-icon">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Cloudinary Widget Script -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <style>
        :root {
            --primary: #0F2C59;
            --secondary: #F8F0E5;
            --accent: #EADBC8;
            --text: #333;
            --white: #fff;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--secondary);
            color: var(--text);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles */
        header {
            background: var(--primary);
            color: var(--white);
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--white);
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .nav-links a {
            color: var(--white);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: var(--accent);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #0056b3);
            color: var(--white);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0056b3, var(--primary));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 44, 89, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
        }
        
        .btn-outline:hover {
            background: rgba(234, 219, 200, 0.1);
            color: var(--accent);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            color: #212529;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            color: white;
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
            color: white;
        }
        
        /* Main Content */
        main {
            margin-top: 80px;
            min-height: calc(100vh - 160px);
            padding: 2rem 0;
        }
        
        /* Auth Styles */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }
        
        .auth-card {
            background: var(--white);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary);
        }
        
        /* Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0.5rem 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Dashboard Orders Summary */
        .dashboard-orders-summary {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .dashboard-orders-summary h4 {
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dashboard-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .dashboard-stat {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            background: #f8f9fa;
        }
        
        .dashboard-stat.pending {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        
        .dashboard-stat.confirmed {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
        }
        
        .dashboard-stat.preparing {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        
        .dashboard-stat.delivered {
            background: #c3e6cb;
            border: 1px solid #b1dfbb;
        }
        
        .dashboard-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .dashboard-stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* ===== ENHANCED PRODUCT CARD STYLES ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.8rem;
            padding: 1.5rem 0;
        }

        .product-card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .product-image-container {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .product-card:hover .product-image {
            transform: scale(1.08);
        }

        .product-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: linear-gradient(135deg, var(--primary), #0056b3);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            z-index: 2;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            letter-spacing: 0.3px;
        }

        .product-details {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .product-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1.4;
            height: 48px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin: 0;
            letter-spacing: -0.2px;
        }

        .product-price-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 0.5rem 0;
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary);
        }

        .product-mrp {
            font-size: 0.95rem;
            color: #999;
            text-decoration: line-through;
        }

        .product-discount {
            font-size: 0.85rem;
            color: #27ae60;
            font-weight: 700;
            background: #eafaf1;
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid #d4f1e0;
        }

        .product-stock {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin: 0.2rem 0;
        }

        .product-stock.in-stock {
            color: #27ae60;
        }

        .product-stock.low-stock {
            color: #f39c12;
        }

        .product-stock.out-of-stock {
            color: #e74c3c;
        }

        .product-actions {
            display: flex;
            gap: 0.6rem;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }

        .btn-add-product, .btn-edit-product {
            flex: 1;
            padding: 0.7rem 1rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-add-product {
            background: linear-gradient(135deg, var(--primary), #0056b3);
            color: white;
            box-shadow: 0 4px 12px rgba(15, 44, 89, 0.2);
        }

        .btn-add-product:hover {
            background: linear-gradient(135deg, #0056b3, var(--primary));
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(15, 44, 89, 0.3);
        }

        .btn-edit-product {
            background: #f8f9fa;
            color: var(--text);
            border: 1px solid #e0e0e0;
        }

        .btn-edit-product:hover {
            background: #e9ecef;
            border-color: #b0b0b0;
            transform: translateY(-2px);
        }

        /* Product Category Badge */
        .product-category {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(15, 44, 89, 0.1);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            align-self: flex-start;
        }

        /* Orders Summary Card */
        .orders-summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            text-align: center;
        }

        .summary-stat {
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .summary-stat.pending {
            background: #fff3cd;
            color: #856404;
        }

        .summary-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            display: block;
        }

        .summary-stat-label {
            font-size: 0.8rem;
            display: block;
        }

        /* Time Inputs */
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .time-input-group input {
            flex: 1;
        }

        /* Service Type Options */
        .service-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .service-option {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .service-option.active {
            border-color: var(--primary);
            background: rgba(15, 44, 89, 0.1);
        }

        .service-option i {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--primary);
        }

        /* Shop Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-open {
            background: #d4edda;
            color: #155724;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-busy {
            background: #fff3cd;
            color: #856404;
        }

        .status-holiday {
            background: #d1ecf1;
            color: #0c5460;
        }

        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--primary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: #fff;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 44, 89, 0.1);
        }
        
        /* Checkbox Styles */
        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .form-check:hover {
            background: #e9ecef;
        }
        
        .form-check-input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .form-check-label {
            cursor: pointer;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 3000;
            max-width: 400px;
        }
        
        .toast {
            background: var(--primary);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success {
            background: var(--success);
        }
        
        .toast.error {
            background: var(--danger);
        }
        
        .toast.warning {
            background: var(--warning);
            color: var(--text);
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .table th,
        .table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background: var(--primary);
            color: var(--white);
            font-weight: 600;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }

        /* Status Text Styles */
        .status-text {
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .status-pending {
            color: #856404;
            background-color: #fff3cd;
        }
        
        .status-confirmed {
            color: #004085;
            background-color: #cce5ff;
        }
        
        .status-preparing {
            color: #0c5460;
            background-color: #d1ecf1;
        }
        
        .status-packed {
            color: #856404;
            background-color: #fff3cd;
        }
        
        .status-ready_for_pickup {
            color: #155724;
            background-color: #d4edda;
        }
        
        .status-picked_up {
            color: #155724;
            background-color: #d4edda;
        }
        
        .status-dispatched {
            color: #856404;
            background-color: #fff3cd;
        }
        
        .status-out_for_delivery {
            color: #856404;
            background-color: #fff3cd;
        }
        
        .status-delivered {
            color: #155724;
            background-color: #d4edda;
        }
        
        .status-cancelled {
            color: #721c24;
            background-color: #f8d7da;
        }
        
        .status-rejected {
            color: #721c24;
            background-color: #f8d7da;
        }

        /* Refund Status Styles */
        .status-refund_pending {
            color: #856404;
            background-color: #fff3cd;
        }
        
        .status-refund_completed {
            color: #155724;
            background-color: #d4edda;
        }
        
        .status-refund_rejected {
            color: #721c24;
            background-color: #f8d7da;
        }
        
        /* Payment Text Styles */
        .payment-text {
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .payment-cod-paid {
            color: #155724;
            background-color: #d4edda;
        }
        
        .payment-cod-unpaid {
            color: #856404;
            background-color: #fff3cd;
        }
        
        .payment-online-paid {
            color: #155724;
            background-color: #d4edda;
        }
        
        .payment-online-unpaid {
            color: #721c24;
            background-color: #f8d7da;
        }
        
        .payment-paid {
            color: #155724;
            background-color: #d4edda;
        }
        
        .payment-unpaid {
            color: #856404;
            background-color: #fff3cd;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* Content Pages */
        .content-page {
            display: none;
        }
        
        .content-page.active {
            display: block;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Item Quantity Control Styles */
        .item-quantity-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .item-quantity-control .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .item-price {
            font-size: 0.85rem;
            color: #666;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .quantity-btn:disabled {
            background: #f8f9fa;
            color: #ccc;
            cursor: not-allowed;
        }

        .quantity-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .max-quantity {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        /* Refund Item Styles */
        .refund-item-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .refund-item-control .item-info {
            flex: 1;
        }

        .refund-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .refund-quantity {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Order Details Modal - FULL SCREEN */
        .order-details-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 3000;
            overflow-y: auto;
            display: none;
        }

        .order-details-fullscreen.active {
            display: block;
        }

        .order-details-header {
            background: var(--primary);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .order-details-header h2 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-details-content {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .order-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .order-section h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .order-section h4 i {
            font-size: 1.2rem;
        }

        .order-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .order-info-item {
            margin-bottom: 0.75rem;
        }

        .order-info-label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .order-info-value {
            font-size: 1rem;
            color: #333;
        }

        .order-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .order-items-table th {
            background: var(--primary);
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .order-items-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .order-items-table tr:last-child td {
            border-bottom: none;
        }

        .order-total {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: right;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .order-total .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* Customer Info Styles */
        .customer-info-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Image Upload Styles */
        .image-upload-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .image-upload-option {
            display: flex;
            gap: 1rem;
        }

        .upload-tab {
            flex: 1;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-tab.active {
            border-color: var(--primary);
            background: rgba(15, 44, 89, 0.05);
        }

        .upload-tab i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .image-preview-container {
            display: none;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview-container.active {
            display: flex;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            border: 2px dashed #ddd;
            padding: 0.5rem;
        }

        .upload-input {
            display: none;
        }

        .upload-btn {
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #0056b3;
        }

        .progress {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        /* Settings Page Styles */
        .settings-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .settings-section h4 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            margin-right: 15px;
            vertical-align: middle;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .toggle-label {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .toggle-label i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .settings-description {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #666;
        }

        .settings-form-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: white;
            border-radius: 10px;
            border: 2px dashed #ddd;
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Refund Options Styles */
        .refund-options-section {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .refund-option-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .refund-option-checkbox {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }

        .refund-option-details {
            flex: 1;
        }

        .refund-option-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .refund-option-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .refund-option-condition {
            font-size: 0.85rem;
            color: #888;
            font-style: italic;
        }

        /* Order Items Status Control */
        .order-item-status-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .order-item-status-control .item-info {
            flex: 1;
        }

        .order-item-status-control select {
            min-width: 150px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        /* Settings Cards - IMPROVED */
        .settings-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .settings-card h5 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.75rem;
        }

        /* Enhanced Form Controls */
        .settings-card .btn {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 1rem;
            min-width: 160px;
        }

        .settings-card .btn-primary {
            background: linear-gradient(135deg, var(--primary), #0056b3);
            border: none;
        }

        .settings-card .btn-primary:hover {
            background: linear-gradient(135deg, #0056b3, var(--primary));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 44, 89, 0.3);
        }

        .settings-card .btn-outline {
            border: 2px solid var(--primary);
            color: var(--primary);
            background: transparent;
        }

        .settings-card .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* Order Items Status */
        .order-item-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .order-item-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .order-item-status.preparing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .order-item-status.packed {
            background: #fff3cd;
            color: #856404;
        }

        .order-item-status.ready {
            background: #d4edda;
            color: #155724;
        }

        .order-item-status.delivered {
            background: #d4edda;
            color: #155724;
        }

        .order-item-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .action-btn i {
            font-size: 0.9rem;
        }

        /* Profile Page Styles */
        .profile-form-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .profile-form-container .btn-primary {
            background: linear-gradient(135deg, var(--primary), #0056b3);
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 1rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-links {
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1rem;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .service-options {
                grid-template-columns: 1fr;
            }

            .image-upload-option {
                flex-direction: column;
            }

            .order-details-header h2 {
                font-size: 1.2rem;
            }

            .order-details-content {
                padding: 1rem;
            }

            .order-section {
                padding: 1rem;
            }

            .order-grid {
                grid-template-columns: 1fr;
            }

            .order-items-table {
                display: block;
                overflow-x: auto;
            }

            .table-responsive {
                overflow-x: auto;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .settings-card {
                padding: 1rem;
            }

            .settings-card h5 {
                font-size: 1.1rem;
            }

            .settings-card .btn {
                width: 100%;
                margin-top: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .auth-card {
                padding: 1.5rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .modal-content {
                padding: 1.5rem;
            }
        }

        /* Desktop View Specific */
        @media (min-width: 769px) {
            .order-details-content {
                padding: 2rem;
            }
            
            .order-section {
                padding: 2rem;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        /* App-like Mobile View */
        @media (max-width: 768px) {
            body {
                background: white;
            }
            
            main {
                margin-top: 70px;
                padding: 1rem 0;
                margin-bottom: 60px;
            }
            
            .container {
                padding: 0 15px;
            }
            
            .content-page.active {
                animation: slideIn 0.3s ease;
            }
            
            .stat-card {
                padding: 1.2rem;
                margin-bottom: 1rem;
            }
            
            .dashboard-orders-summary {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .orders-summary-card {
                padding: 15px;
                margin-bottom: 15px;
            }
        }

        /* Floating Orders Button */
        .floating-orders-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .floating-orders-btn.active {
            display: flex;
        }

        .floating-orders-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Quick Actions Toolbar */
        .quick-actions-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            padding: 10px;
            display: none;
            justify-content: space-around;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: #666;
            font-size: 0.8rem;
            gap: 5px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .quick-action-btn.active {
            background: var(--primary);
            color: white;
        }

        .quick-action-btn i {
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .quick-actions-toolbar {
                display: flex;
            }
            
            main {
                margin-bottom: 60px;
            }
        }

        /* Offline Warning */
        .offline-warning {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            text-align: center;
            z-index: 9999;
            display: none;
            font-weight: bold;
        }

        .offline-warning i {
            margin-right: 10px;
        }

        /* Timeline Styles for Refund Details */
        .timeline {
            position: relative;
            padding-left: 2rem;
            margin: 1rem 0;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .timeline-marker {
            position: absolute;
            left: -2rem;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
        }

        .timeline-content {
            padding-left: 1rem;
        }

        .timeline-content h6 {
            margin-bottom: 0.25rem;
            color: #495057;
        }
    </style>
</head>
<body>
    <!-- Offline Warning -->
    <div class="offline-warning" id="offlineWarning">
        <i class="fas fa-wifi-slash"></i> No Internet Connection
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">üè™ Raashanmart Shop</div>
                <div class="nav-links">
                    <a href="#" data-page="dashboard">Dashboard</a>
                    <a href="#" data-page="products">Products</a>
                    <a href="#" data-page="orders">Orders <span class="orders-badge" style="display: none;">0</span></a>
                    <a href="#" data-page="refunds">Refunds</a>
                    <a href="#" data-page="settings">Settings</a>
                    <a href="#" data-page="profile">Profile</a>
                    <button class="btn btn-outline" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>

            <!-- Auth Screen -->
            <div id="authScreen">
                <div class="auth-container">
                    <div class="auth-card">
                        <h2 class="auth-title">Shopkeeper Login</h2>
                        <div id="debugInfo" style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 12px; display: none;">
                            <strong>Debug Info:</strong> <span id="debugText"></span>
                        </div>
                        <form id="loginForm">
                            <div class="form-group">
                                <label for="loginEmail">Email</label>
                                <input type="email" id="loginEmail" required placeholder="Enter your email">
                            </div>
                            <div class="form-group">
                                <label for="loginPassword">Password</label>
                                <input type="password" id="loginPassword" required placeholder="Enter your password">
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Login</button>
                            <div class="text-center mt-3">
                              <a href="#" onclick="showForgotPassword()" class="text-muted">Forgot Password?</a>
                            </div>
                        </form>
                        <div style="text-align: center; margin-top: 1rem;">
                            <small>Don't have an account? Contact admin</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- App Screen -->
            <div id="appScreen" style="display: none;">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="content-page active">
                    <h2 style="margin-bottom: 2rem; color: var(--primary);">Dashboard</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Products</div>
                            <div class="stat-value" id="totalProducts">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pending Orders</div>
                            <div class="stat-value" id="pendingOrders">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-value" id="totalRevenue">‚Çπ0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pending Refunds</div>
                            <div class="stat-value" id="pendingRefunds">0</div>
                        </div>
                    </div>

                    <!-- Dashboard Orders Summary -->
                    <div class="dashboard-orders-summary" id="dashboardOrdersSummary">
                        <h4><i class="fas fa-shopping-bag"></i> Order Management Summary</h4>
                        <div class="dashboard-stats-grid" id="dashboardOrdersStats">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="navigateToPage('products')">
                            <i class="fas fa-box"></i> Manage Products
                        </button>
                        <button class="btn btn-outline" onclick="navigateToPage('orders')">
                            <i class="fas fa-shopping-bag"></i> View Orders
                        </button>
                        <button class="btn btn-primary" onclick="navigateToPage('refunds')">
                            <i class="fas fa-exchange-alt"></i> Manage Refunds
                        </button>
                        <button class="btn btn-outline" onclick="navigateToPage('settings')">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>
                </div>

                <!-- Products Page -->
                <div id="productsPage" class="content-page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                        <h2 style="color: var(--primary);">Product Management</h2>
                        <div style="display: flex; gap: 1rem;">
                            <input type="text" id="productSearch" placeholder="Search products..." class="form-control" style="margin: 0; min-width: 200px;">
                            <button class="btn btn-primary" onclick="showAddProductModal()">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                        </div>
                    </div>

                    <div class="products-grid" id="productsList">
                        <!-- Products will be loaded here -->
                    </div>
                </div>

                <!-- Orders Page -->
                <div id="ordersPage" class="content-page">
                    <h2 style="margin-bottom: 1rem; color: var(--primary);">Order Management</h2>
                    
                    <!-- Orders Summary Card -->
                    <div class="orders-summary-card" id="ordersSummaryCard">
                        <h4 style="margin-bottom: 10px;">üìä Quick Summary</h4>
                        <div class="summary-stats">
                            <div class="summary-stat pending">
                                <span class="summary-stat-value" id="pendingSummary">0</span>
                                <span class="summary-stat-label">Pending</span>
                            </div>
                            <div class="summary-stat">
                                <span class="summary-stat-value" id="confirmedSummary">0</span>
                                <span class="summary-stat-label">Confirmed</span>
                            </div>
                            <div class="summary-stat">
                                <span class="summary-stat-value" id="preparingSummary">0</span>
                                <span class="summary-stat-label">Preparing</span>
                            </div>
                            <div class="summary-stat">
                                <span class="summary-stat-value" id="totalSummary">0</span>
                                <span class="summary-stat-label">Total</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Order Filter -->
                    <div class="mb-3">
                        <select id="orderStatusFilter" class="form-select" style="max-width: 200px;" onchange="filterOrders()">
                            <option value="all">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="preparing">Preparing</option>
                            <option value="packed">Packed</option>
                            <option value="ready_for_pickup">Ready for Pickup</option>
                            <option value="out_for_delivery">Out for Delivery</option>
                            <option value="delivered">Delivered</option>
                            <option value="picked_up">Picked Up</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Payment</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersList">
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Refunds Page -->
                <div id="refundsPage" class="content-page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                        <h2 style="color: var(--primary);">Refund Management</h2>
                        <div style="display: flex; gap: 1rem;">
                            <select id="refundStatusFilter" class="form-select" style="max-width: 200px;" onchange="filterRefunds()">
                                <option value="all">All Refunds</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>

                    <!-- Refunds Summary -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-label">Pending Refunds</div>
                            <div class="stat-value" id="refundStatsPending">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Completed Refunds</div>
                            <div class="stat-value" id="refundStatsCompleted">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Rejected Refunds</div>
                            <div class="stat-value" id="refundStatsRejected">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Refund Amount</div>
                            <div class="stat-value" id="refundStatsAmount">‚Çπ0</div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Refund ID</th>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Initiated On</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="refundsList">
                                <!-- Refunds will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" class="content-page">
                    <h2 style="margin-bottom: 2rem; color: var(--primary);">Shop Settings</h2>
                    
                    <!-- UPI & Payment Settings Card -->
<div class="settings-card">
    <h5><i class="fas fa-qrcode"></i> UPI & Payment Settings</h5>
    <form id="upiSettingsForm">
        <div class="form-group">
            <label for="upiId">UPI ID</label>
            <input type="text" id="upiId" placeholder="yourname@upi" class="form-control">
            <small class="text-muted">Enter your UPI ID for QR code payments</small>
        </div>
        
        <!-- QR Code Image Upload Section -->
        <div class="form-group">
            <label>QR Code Image</label>
            <div class="image-upload-container">
                <div class="image-upload-option">
                    <div class="upload-tab active" data-type="url" onclick="switchQRImageTab('url')">
                        <i class="fas fa-link"></i>
                        <span>Image URL</span>
                    </div>
                    <div class="upload-tab" data-type="cloudinary" onclick="switchQRImageTab('cloudinary')">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Upload with Cloudinary</span>
                    </div>
                </div>
                
                <!-- URL Input -->
                <div class="image-preview-container active" id="qrUrlTab">
                    <input type="url" id="qrCodeImageUrl" placeholder="https://example.com/qr-code.png" class="form-control">
                    <button type="button" class="upload-btn" onclick="previewQRImageFromUrl()">
                        <i class="fas fa-eye"></i> Preview QR Code
                    </button>
                    <img id="qrUrlImagePreview" class="image-preview" style="display: none;">
                </div>
                
                <!-- Cloudinary Upload -->
                <div class="image-preview-container" id="qrCloudinaryTab">
                    <button type="button" class="upload-btn" onclick="openCloudinaryQRUploader()">
                        <i class="fas fa-cloud-upload-alt"></i> Upload QR Code Image
                    </button>
                    <div id="cloudinaryQRUploadStatus" style="display: none; margin-top: 10px;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <span>Uploading QR Code to Cloudinary...</span>
                        </div>
                    </div>
                    <img id="cloudinaryQRImagePreview" class="image-preview" style="display: none;">
                    <div id="cloudinaryQRImageInfo" style="display: none; margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <i class="fas fa-check-circle text-success"></i>
                        <span>QR Code uploaded to Cloudinary successfully</span>
                    </div>
                </div>
            </div>
            <input type="hidden" id="cloudinaryQRImageUrl">
        </div>
        
        <div class="form-group">
            <label>Accepted Payment Methods</label>
            <div style="margin-top: 10px;">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="acceptCash" checked>
                    <label class="form-check-label" for="acceptCash">
                        <i class="fas fa-money-bill-wave"></i> Cash on Delivery
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="acceptUPI" checked>
                    <label class="form-check-label" for="acceptUPI">
                        <i class="fas fa-qrcode"></i> UPI/QR Code Payment
                    </label>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-primary" onclick="saveUPISettings()">
            <i class="fas fa-save"></i> Save Payment Settings
        </button>
    </form>
</div>

                    <!-- Coupon Management Card -->
                    <div class="settings-card">
                        <h5><i class="fas fa-ticket-alt"></i> Coupon Management</h5>
                        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="couponSystemEnabled" onchange="toggleCouponSystem()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="font-weight: 600; margin-left: 10px;" id="couponSystemStatus">Coupon System: Disabled</span>
                        </div>
                        
                        <div id="couponSettingsSection" style="display: none;">
                            <div class="settings-form-section">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Coupon Code</label>
                                        <input type="text" id="couponCode" placeholder="SHOP10" maxlength="10" class="form-control">
                                        <small class="text-muted">Max 10 characters</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Discount Type</label>
                                        <select id="couponDiscountType" class="form-control">
                                            <option value="percentage">Percentage (%)</option>
                                            <option value="fixed">Fixed Amount (‚Çπ)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Discount Value</label>
                                        <input type="number" id="couponValue" min="0" step="0.01" class="form-control">
                                        <small class="text-muted">Percentage (1-100) or Fixed Amount</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Minimum Order Amount (‚Çπ)</label>
                                        <input type="number" id="couponMinOrder" min="0" step="0.01" class="form-control">
                                        <small class="text-muted">Minimum cart value to apply coupon</small>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Maximum Discount (‚Çπ)</label>
                                        <input type="number" id="couponMaxDiscount" min="0" step="0.01" class="form-control">
                                        <small class="text-muted">0 for no limit</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Valid Until</label>
                                        <input type="date" id="couponValidUntil" class="form-control">
                                        <small class="text-muted">Leave empty for no expiry</small>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Usage Limit</label>
                                        <input type="number" id="couponUsageLimit" min="0" class="form-control">
                                        <small class="text-muted">0 for unlimited uses</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Active</label>
                                        <select id="couponActive" class="form-control">
                                            <option value="true">Yes</option>
                                            <option value="false">No</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Coupon Description</label>
                                    <textarea id="couponDescription" rows="2" class="form-control" placeholder="Describe this coupon..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <button type="button" class="btn btn-primary" onclick="saveCouponSettings()">
                                        <i class="fas fa-save"></i> Save Coupon Settings
                                    </button>
                                    <button type="button" class="btn btn-outline" onclick="clearCouponForm()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shop Restrictions Card -->
                    <div class="settings-card">
                        <h5><i class="fas fa-ban"></i> Shop Restrictions</h5>
                        <form id="restrictionsForm">
                            <div class="form-group">
                                <label>Maximum Order Distance (km)</label>
                                <input type="number" id="maxOrderDistance" min="0" max="50" step="1" class="form-control">
                                <small class="text-muted">0 for no limit, maximum 50km</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Minimum Order Amount (‚Çπ)</label>
                                <input type="number" id="minOrderAmount" min="0" step="0.01" class="form-control">
                                <small class="text-muted">Minimum amount for order placement</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Maximum Items per Order</label>
                                <input type="number" id="maxItemsPerOrder" min="0" class="form-control">
                                <small class="text-muted">0 for no limit</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Delivery Hours</label>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Start Time</label>
                                        <input type="time" id="deliveryStartTime" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>End Time</label>
                                        <input type="time" id="deliveryEndTime" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Blocked Customers</label>
                                <textarea id="blockedCustomers" rows="3" class="form-control" placeholder="Enter customer IDs or phone numbers separated by commas"></textarea>
                                <small class="text-muted">These customers won't be able to place orders</small>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="saveRestrictions()">
                                <i class="fas fa-save"></i> Save Restrictions
                            </button>
                        </form>
                    </div>

                    <!-- Order Management Settings Card -->
                    <div class="settings-card">
                        <h5><i class="fas fa-cogs"></i> Order Management Settings</h5>
                        <form id="orderSettingsForm">
                            <div class="form-group">
                                <label>Auto-Accept Orders</label>
                                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoAcceptOrders">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="margin-left: 10px;">Automatically accept incoming orders</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Auto-Reject Orders When</label>
                                <div style="margin-top: 10px;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rejectOutOfStock">
                                        <label class="form-check-label" for="rejectOutOfStock">
                                            Items are out of stock
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rejectAfterHours">
                                        <label class="form-check-label" for="rejectAfterHours">
                                            Order placed outside business hours
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rejectBelowMinAmount">
                                        <label class="form-check-label" for="rejectBelowMinAmount">
                                            Order amount below minimum
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Default Preparation Time (minutes)</label>
                                <input type="number" id="defaultPrepTime" min="5" max="180" class="form-control">
                                <small class="text-muted">Estimated time to prepare orders</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Order Status Notifications</label>
                                <div style="margin-top: 10px;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifyOnAccept" checked>
                                        <label class="form-check-label" for="notifyOnAccept">
                                            Notify customer when order is accepted
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifyOnReady" checked>
                                        <label class="form-check-label" for="notifyOnReady">
                                            Notify when order is ready
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifyOnDelivery" checked>
                                        <label class="form-check-label" for="notifyOnDelivery">
                                            Notify when order is out for delivery
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="saveOrderSettings()">
                                <i class="fas fa-save"></i> Save Order Settings
                            </button>
                        </form>
                    </div>

                    <!-- Advanced Settings Card -->
                    <div class="settings-card">
                        <h5><i class="fas fa-sliders-h"></i> Advanced Settings</h5>
                        <div class="form-group">
                            <label>Shop Configuration Sync</label>
                            <button type="button" class="btn btn-outline" onclick="syncShopConfig()">
                                <i class="fas fa-sync"></i> Sync with Customer App
                            </button>
                            <small class="text-muted d-block mt-1">Sync your settings with the customer app</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Data Export</label>
                            <button type="button" class="btn btn-outline" onclick="exportShopData()">
                                <i class="fas fa-download"></i> Export Shop Data
                            </button>
                            <small class="text-muted d-block mt-1">Export products, orders, and settings</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Reset Settings</label>
                            <button type="button" class="btn btn-danger" onclick="resetSettings()">
                                <i class="fas fa-trash"></i> Reset to Defaults
                            </button>
                            <small class="text-muted d-block mt-1">This will reset all settings to default values</small>
                        </div>
                    </div>
                </div>

                <!-- Profile Page -->
                <div id="profilePage" class="content-page">
                    <h2 style="margin-bottom: 2rem; color: var(--primary);">Shop Profile</h2>
                    
                    <div class="profile-form-container">
                        <form id="profileForm">
                            <div class="form-group">
                                <label>Shop Name</label>
                                <input type="text" id="shopName" required>
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="shopCategory" required>
                                    <option value="groceries">Groceries</option>
                                    <option value="cosmetics">Cosmetics</option>
                                    <option value="clothing">Clothing</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="medical">Medical</option>
                                    <option value="stationery">Stationery</option>
                                    <option value="other">Other (Create New)</option>
                                </select>
                            </div>
                            <div id="newCategoryInput" style="display: none;">
                                <div class="form-group">
                                    <label>New Category Name</label>
                                    <input type="text" id="newCategoryName" placeholder="Enter new category name">
                                    <small class="text-muted">This category will be available for your products and in customer app</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="shopDescription" rows="3" placeholder="Describe your shop..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Address</label>
                                <textarea id="shopAddress" rows="2" required placeholder="Full shop address"></textarea>
                            </div>
                            
                            <!-- Shop Timings Section -->
                            <div class="form-group">
                                <label>Shop Timings</label>
                                <div class="time-input-group">
                                    <input type="time" id="shopOpenTime" value="09:00">
                                    <span>to</span>
                                    <input type="time" id="shopCloseTime" value="21:00">
                                </div>
                            </div>
                            
                            <!-- Service Type Section -->
                            <div class="form-group">
                                <label>Service Type</label>
                                <div class="service-options" id="serviceOptions">
                                    <div class="service-option" data-value="both">
                                        <i class="fas fa-truck"></i>
                                        <span>Both Delivery & Pickup</span>
                                    </div>
                                    <div class="service-option" data-value="delivery_only">
                                        <i class="fas fa-motorcycle"></i>
                                        <span>Delivery Only</span>
                                    </div>
                                    <div class="service-option" data-value="pickup_only">
                                        <i class="fas fa-store"></i>
                                        <span>Pickup Only</span>
                                    </div>
                                </div>
                                <input type="hidden" id="deliveryType" value="both">
                            </div>
                            
                            <!-- Shop Status Section -->
                            <div class="form-group">
                                <label>Shop Status</label>
                                <select id="shopStatus">
                                    <option value="open">üü¢ Open</option>
                                    <option value="closed">üî¥ Closed</option>
                                    <option value="busy">üü° Busy (Accepting orders)</option>
                                    <option value="holiday">üèñÔ∏è On Holiday</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="shopPhone" required placeholder="+91 1234567890">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Product Modal with Cloudinary Image Upload -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Add New Product</h3>
                <button class="close-modal" onclick="closeProductModal()">&times;</button>
            </div>
            <form id="productForm">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="productCategory" required>
                        <option value="groceries">Groceries</option>
                        <option value="dairy">Dairy</option>
                        <option value="bakery">Bakery</option>
                        <option value="beverages">Beverages</option>
                        <option value="snacks">Snacks</option>
                        <option value="personal_care">Personal Care</option>
                        <option value="household">Household</option>
                        <option value="other">Other (Custom)</option>
                    </select>
                </div>
                <div id="customCategoryInput" style="display: none;">
                    <div class="form-group">
                        <label>Custom Category Name</label>
                        <input type="text" id="customCategoryName" placeholder="Enter custom category">
                        <small class="text-muted">This category will be saved for future use</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>Price (‚Çπ)</label>
                    <input type="number" id="productPrice" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>MRP (‚Çπ)</label>
                    <input type="number" id="productMrp" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Stock Quantity</label>
                    <input type="number" id="productStock" required min="0">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="productDescription" rows="3"></textarea>
                </div>
                
                <!-- Product Refund Options -->
                <div class="form-group">
                    <label>Refund & Return Policy</label>
                    <div style="margin-bottom: 10px;">
                        <input type="checkbox" id="productRefundAvailable" checked>
                        <label for="productRefundAvailable" style="margin-left: 8px;">Refund & Return Available for this product</label>
                    </div>
                    <div id="productRefundDetails" style="margin-top: 10px;">
                        <div class="form-group">
                            <label>Refund Period (Days)</label>
                            <input type="number" id="productRefundPeriod" min="1" max="30" value="7">
                            <small class="text-muted">Number of days after delivery for refund eligibility</small>
                        </div>
                        <div class="form-group">
                            <label>Refund Type</label>
                            <select id="productRefundType">
                                <option value="use_shop_default">Use Shop Default Policy</option>
                                <option value="full_refund">Full Refund</option>
                                <option value="partial_refund">Partial Refund</option>
                                <option value="store_credit">Store Credit Only</option>
                                <option value="no_refund">No Refund</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Special Conditions (Optional)</label>
                            <textarea id="productRefundConditions" rows="2" placeholder="e.g., Non-returnable if opened, sealed items only..."></textarea>
                            <small class="text-muted">Leave empty to use shop default conditions</small>
                        </div>
                    </div>
                </div>
                
                <!-- Cloudinary Image Upload Section -->
                <div class="form-group">
                    <label>Product Image</label>
                    <div class="image-upload-container">
                        <div class="image-upload-option">
                            <div class="upload-tab active" data-type="url" onclick="switchImageTab('url')">
                                <i class="fas fa-link"></i>
                                <span>Image URL</span>
                            </div>
                            <div class="upload-tab" data-type="cloudinary" onclick="switchImageTab('cloudinary')">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Upload with Cloudinary</span>
                            </div>
                        </div>
                        
                        <!-- URL Input -->
                        <div class="image-preview-container active" id="urlTab">
                            <input type="url" id="productImage" placeholder="https://example.com/image.jpg">
                            <button type="button" class="upload-btn" onclick="previewImageFromUrl()">
                                <i class="fas fa-eye"></i> Preview Image
                            </button>
                            <img id="urlImagePreview" class="image-preview" style="display: none;">
                        </div>
                        
                        <!-- Cloudinary Upload -->
                        <div class="image-preview-container" id="cloudinaryTab">
                            <button type="button" class="upload-btn" onclick="openCloudinaryUploader()">
                                <i class="fas fa-cloud-upload-alt"></i> Upload Product Image
                            </button>
                            <div id="cloudinaryUploadStatus" style="display: none; margin-top: 10px;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Uploading to Cloudinary...</span>
                                </div>
                            </div>
                            <img id="cloudinaryImagePreview" class="image-preview" style="display: none;">
                            <div id="cloudinaryImageInfo" style="display: none; margin-top: 10px; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-check-circle text-success"></i>
                                <span>Image uploaded to Cloudinary successfully</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="cloudinaryImageUrl">
                </div>
            </form>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-outline" onclick="closeProductModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Partial Order Modal -->
    <div class="modal" id="partialOrderModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Accept Partial Order</h3>
                <button class="close-modal" onclick="closePartialOrderModal()">&times;</button>
            </div>
            <div id="partialOrderItems">
                <!-- Items will be loaded here -->
            </div>
            <div id="partialOrderTotal" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; text-align: right;">
                <strong>Total: ‚Çπ<span id="partialOrderTotalAmount">0</span></strong>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-outline" onclick="closePartialOrderModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmPartialOrder()">Confirm Partial Order</button>
            </div>
        </div>
    </div>

    <!-- Order Details Full Screen Modal -->
    <div class="order-details-fullscreen" id="orderDetailsModal">
        <div class="order-details-header">
            <h2><i class="fas fa-shopping-bag"></i> Order Details</h2>
            <button class="close-modal" onclick="closeOrderDetailsModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div class="order-details-content" id="orderDetailsContent">
            <!-- Order details will be loaded here -->
        </div>
    </div>

    <!-- Order Items Status Modal -->
    <div class="modal" id="orderItemsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Update Order Items Status</h3>
                <button class="close-modal" onclick="closeOrderItemsModal()">&times;</button>
            </div>
            <div id="orderItemsList">
                <!-- Order items will be loaded here -->
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-outline" onclick="closeOrderItemsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveOrderItemsStatus()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Initiate Refund Modal -->
    <div class="modal" id="initiateRefundModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Initiate Refund</h3>
                <button class="close-modal" onclick="closeInitiateRefundModal()">&times;</button>
            </div>
            <form id="refundForm">
                <input type="hidden" id="refundOrderId">
                <input type="hidden" id="refundCustomerId">
                
                <div class="form-group">
                    <label>Order ID</label>
                    <input type="text" id="displayOrderId" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label>Customer</label>
                    <input type="text" id="refundCustomerName" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label>Refund Items</label>
                    <div id="refundItemsList">
                        <!-- Items will be loaded here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Refund Amount (‚Çπ)</label>
                    <input type="number" id="refundAmount" class="form-control" required min="0" step="0.01">
                    <small class="text-muted">Maximum refundable amount: ‚Çπ<span id="maxRefundAmount">0</span></small>
                </div>
                
                <div class="form-group">
                    <label>Refund Reason</label>
                    <select id="refundReason" class="form-select" required>
                        <option value="">Select Reason</option>
                        <option value="Product Quality Issue">Product Quality Issue</option>
                        <option value="Wrong Product Delivered">Wrong Product Delivered</option>
                        <option value="Damaged Product">Damaged Product</option>
                        <option value="Order Cancelled">Order Cancelled</option>
                        <option value="Customer Request">Customer Request</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Additional Notes</label>
                    <textarea id="refundNotes" rows="3" class="form-control" placeholder="Any additional information about the refund..."></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Refund will be processed within 24-48 hours. Customer will be notified via email/SMS.
                </div>
            </form>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-outline" onclick="closeInitiateRefundModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitRefund()">Initiate Refund</button>
            </div>
        </div>
    </div>

    <!-- Refund Details Modal -->
    <div class="modal" id="refundDetailsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Refund Details</h3>
                <button class="close-modal" onclick="closeRefundDetailsModal()">&times;</button>
            </div>
            <div id="refundDetailsContent">
                <!-- Refund details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Quick Actions Toolbar -->
    <div class="quick-actions-toolbar" id="quickActionsToolbar">
        <button class="quick-action-btn" data-page="dashboard" onclick="navigateToPage('dashboard')">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
        </button>
        <button class="quick-action-btn" data-page="orders" onclick="navigateToPage('orders')">
            <i class="fas fa-shopping-bag"></i>
            <span>Orders</span>
            <span class="orders-badge" style="display: none;">0</span>
        </button>
        <button class="quick-action-btn" data-page="refunds" onclick="navigateToPage('refunds')">
            <i class="fas fa-exchange-alt"></i>
            <span>Refunds</span>
        </button>
        <button class="quick-action-btn" data-page="profile" onclick="navigateToPage('profile')">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </button>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD2-yz4xwYD5S_oXs6ryhNP8XIC94jzda4",
            authDomain: "dukaan-platform.firebaseapp.com",
            projectId: "dukaan-platform",
            storageBucket: "dukaan-platform.firebasestorage.app",
            messagingSenderId: "75765851780",
            appId: "1:75765851780:web:dd9567db1d39c3b09c84d1",
            measurementId: "G-QJB3MFSSSS"
        };

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: 'db1rbtgpe',
            uploadPreset: 'dukaan-platform',
            apiKey: '156538295145313',
            sources: ['local', 'camera', 'url'],
            folder: 'shopkeeper_qr_codes',
            multiple: false,
            resourceType: 'image',
            clientAllowedFormats: ['jpg', 'png', 'gif', 'webp', 'jpeg'],
            maxFileSize: 5000000,
            theme: 'white',
            cropping: false,
            showAdvancedOptions: false,
            styles: {
                palette: {
                    window: "#FFFFFF",
                    windowBorder: "#0F2C59",
                    tabIcon: "#0F2C59",
                    menuIcons: "#0F2C59",
                    textDark: "#000000",
                    textLight: "#FFFFFF",
                    link: "#0F2C59",
                    action: "#0F2C59",
                    inactiveTabIcon: "#555555",
                    error: "#F44235",
                    inProgress: "#0078FF",
                    complete: "#20B832",
                    sourceBg: "#E4EBF1"
                }
            }
        };

        // Initialize Firebase
        let auth = null;
        let db = null;
        let storage = null;
        let currentShop = null;
        let products = [];
        let orders = [];
        let filteredOrders = [];
        let refunds = [];
        let filteredRefunds = [];
        let currentPartialOrderId = null;
        let partialOrderItems = [];
        let currentRefundOrder = null;
        let isOnline = navigator.onLine;
        let ordersListener = null;
        let messaging = null;
        let currentImageTab = 'url';
        let currentQRImageTab = 'url';
        let cloudinaryWidget = null;
        let cloudinaryQRWidget = null;
        let notificationSound = null;
        let currentShopConfig = null;
        let currentOrderItems = [];
        let shopCategories = ['groceries', 'dairy', 'bakery', 'beverages', 'snacks', 'personal_care', 'household'];

        // Initialize App
        function initApp() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                } else {
                    firebase.app();
                }
                
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                
                notificationSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
                notificationSound.volume = 0.5;
                
                setupPushNotifications();
                setupOrderListener();
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        await loadShopData(user.uid);
                    }
                });

                setupNetworkDetection();
                initializeCloudinaryWidgets();
                
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showToast("Firebase initialization failed. Please refresh the page.", "error");
            }
        }

        // Initialize Cloudinary Widgets
        function initializeCloudinaryWidgets() {
            try {
                // Product Image Upload Widget
                cloudinaryWidget = cloudinary.createUploadWidget(
                    {
                        ...cloudinaryConfig,
                        folder: 'shop_products'
                    },
                    (error, result) => {
                        handleCloudinaryUpload(error, result, 'product');
                    }
                );

                // QR Code Upload Widget
                cloudinaryQRWidget = cloudinary.createUploadWidget(
                    {
                        ...cloudinaryConfig,
                        folder: 'shop_qr_codes',
                        cropping: true,
                        croppingAspectRatio: 1,
                        croppingShowDimensions: true
                    },
                    (error, result) => {
                        handleCloudinaryUpload(error, result, 'qr');
                    }
                );
            } catch (error) {
                console.error('Error initializing Cloudinary widgets:', error);
                showToast('Cloudinary initialization failed. Please refresh page.', 'warning');
            }
        }

        // Handle Cloudinary Upload
        function handleCloudinaryUpload(error, result, type) {
            if (error) {
                console.error('Cloudinary Error:', error);
                showToast('Cloudinary upload error', 'error');
                if (type === 'product') {
                    document.getElementById('cloudinaryUploadStatus').style.display = 'none';
                } else {
                    document.getElementById('cloudinaryQRUploadStatus').style.display = 'none';
                }
                return;
            }
            
            if (result && result.event === "queues-start") {
                if (type === 'product') {
                    document.getElementById('cloudinaryUploadStatus').style.display = 'block';
                } else {
                    document.getElementById('cloudinaryQRUploadStatus').style.display = 'block';
                }
            }
            
            if (result && result.event === "success") {
                const imageUrl = result.info.secure_url;
                
                if (type === 'product') {
                    document.getElementById('cloudinaryImageUrl').value = imageUrl;
                    document.getElementById('productImage').value = imageUrl;
                    
                    const preview = document.getElementById('cloudinaryImagePreview');
                    preview.src = imageUrl;
                    preview.style.display = 'block';
                    
                    document.getElementById('cloudinaryImageInfo').style.display = 'block';
                    document.getElementById('cloudinaryUploadStatus').style.display = 'none';
                } else {
                    document.getElementById('cloudinaryQRImageUrl').value = imageUrl;
                    document.getElementById('qrCodeImageUrl').value = imageUrl;
                    
                    const preview = document.getElementById('cloudinaryQRImagePreview');
                    preview.src = imageUrl;
                    preview.style.display = 'block';
                    
                    document.getElementById('cloudinaryQRImageInfo').style.display = 'block';
                    document.getElementById('cloudinaryQRUploadStatus').style.display = 'none';
                }
                
                showToast('‚úÖ Image uploaded successfully!', 'success');
            }
            
            if (result && result.event === "close") {
                if (type === 'product') {
                    document.getElementById('cloudinaryUploadStatus').style.display = 'none';
                } else {
                    document.getElementById('cloudinaryQRUploadStatus').style.display = 'none';
                }
            }
        }

        // Open Cloudinary uploader for product
        function openCloudinaryUploader() {
            if (!cloudinaryWidget) {
                showToast('Cloudinary uploader not initialized. Please refresh page.', 'error');
                return;
            }
            
            try {
                document.getElementById('cloudinaryUploadStatus').style.display = 'block';
                document.getElementById('cloudinaryImagePreview').style.display = 'none';
                document.getElementById('cloudinaryImageInfo').style.display = 'none';
                
                cloudinaryWidget.open();
            } catch (error) {
                console.error('Error opening Cloudinary widget:', error);
                showToast('Cannot open uploader: ' + error.message, 'error');
            }
        }

        // Open Cloudinary uploader for QR code
        function openCloudinaryQRUploader() {
            if (!cloudinaryQRWidget) {
                showToast('QR Code uploader not initialized. Please refresh page.', 'error');
                return;
            }
            
            try {
                document.getElementById('cloudinaryQRUploadStatus').style.display = 'block';
                document.getElementById('cloudinaryQRImagePreview').style.display = 'none';
                document.getElementById('cloudinaryQRImageInfo').style.display = 'none';
                
                cloudinaryQRWidget.open();
            } catch (error) {
                console.error('Error opening Cloudinary QR widget:', error);
                showToast('Cannot open QR uploader: ' + error.message, 'error');
            }
        }

        // QR Code Image Tab Functions
        function switchQRImageTab(type) {
            currentQRImageTab = type;
            
            document.querySelectorAll('.upload-tab[data-type^="qr"]').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.type === 'qr-' + type) {
                    tab.classList.add('active');
                }
            });
            
            document.getElementById('qrUrlTab').classList.toggle('active', type === 'url');
            document.getElementById('qrCloudinaryTab').classList.toggle('active', type === 'cloudinary');
            
            if (type === 'url') {
                document.getElementById('qrCodeImageUrl').value = '';
                document.getElementById('qrUrlImagePreview').style.display = 'none';
            } else {
                document.getElementById('cloudinaryQRImagePreview').style.display = 'none';
                document.getElementById('cloudinaryQRImageInfo').style.display = 'none';
                document.getElementById('cloudinaryQRUploadStatus').style.display = 'none';
                document.getElementById('cloudinaryQRImageUrl').value = '';
            }
        }

        function previewQRImageFromUrl() {
            const url = document.getElementById('qrCodeImageUrl').value;
            if (url) {
                const preview = document.getElementById('qrUrlImagePreview');
                preview.src = url;
                preview.style.display = 'block';
                preview.onerror = function() {
                    showToast('Could not load QR image from URL', 'error');
                    preview.style.display = 'none';
                };
                document.getElementById('cloudinaryQRImageUrl').value = url;
            }
        }

        // Setup push notifications
        async function setupPushNotifications() {
            try {
                if (!('Notification' in window)) {
                    console.log('This browser does not support notifications');
                    return;
                }
                
                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        console.log('Notification permission granted');
                        
                        if (firebase.messaging.isSupported()) {
                            messaging = firebase.messaging();
                            
                            // VAPID Key for push notifications
                            const vapidKey = "BC8-qBqG-JuB3xKp-6nE3lNlUq4pE2g7pW8w9Xj4kF5yM8rV9tH1jK2lP3mN4oQ5rS6tU7vW8xY9zA0bB1cC2dD3eE4fF5gG6hH7iI8jJ9";
                            
                            messaging.getToken({vapidKey: vapidKey})
                                .then((currentToken) => {
                                    if (currentToken && currentShop) {
                                        db.collection('shops').doc(currentShop.id).update({
                                            fcmToken: currentToken,
                                            notificationEnabled: true,
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                    }
                                })
                                .catch((err) => {
                                    console.log('Error getting FCM token:', err);
                                });

                            messaging.onMessage((payload) => {
                                console.log('Message received in foreground:', payload);
                                playNotificationSound();
                                
                                if (payload.notification) {
                                    showNotification(
                                        payload.notification.title || 'New Order',
                                        payload.notification.body || 'You have a new order!'
                                    );
                                }
                                
                                if (currentShop) {
                                    loadOrders();
                                    loadDashboardData();
                                }
                            });
                        }
                    }
                } else if (Notification.permission === 'granted') {
                    if (firebase.messaging.isSupported()) {
                        messaging = firebase.messaging();
                        
                        const vapidKey = "BC8-qBqG-JuB3xKp-6nE3lNlUq4pE2g7pW8w9Xj4kF5yM8rV9tH1jK2lP3mN4oQ5rS6tU7vW8xY9zA0bB1cC2dD3eE4fF5gG6hH7iI8jJ9";
                        
                        messaging.getToken({vapidKey: vapidKey})
                            .then((currentToken) => {
                                if (currentToken && currentShop) {
                                    db.collection('shops').doc(currentShop.id).update({
                                        fcmToken: currentToken,
                                        notificationEnabled: true,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                }
                            });
                    }
                }
                
            } catch (error) {
                console.error('Error setting up push notifications:', error);
            }
        }

        // Setup order listener for real-time updates
        function setupOrderListener() {
            if (!currentShop || !db) return;
            
            try {
                ordersListener = db.collection('orders')
                    .where('shopId', '==', currentShop.id)
                    .where('status', '==', 'pending')
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                const order = change.doc.data();
                                playNotificationSound();
                                showNotification(
                                    'üõçÔ∏è New Order Received!',
                                    `Order #${order.orderId?.substring(order.orderId.length - 6) || 'N/A'} from ${order.customerName || 'Customer'}`
                                );
                                loadOrders();
                                loadDashboardData();
                            }
                        });
                    }, (error) => {
                        console.error('Order listener error:', error);
                    });
            } catch (error) {
                console.error('Error setting up order listener:', error);
            }
        }

        function showNotification(title, body) {
            if (!("Notification" in window)) {
                console.log("This browser does not support notifications");
                return;
            }
            
            if (Notification.permission === "granted") {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/3082/3082383.png',
                    badge: 'https://cdn-icons-png.flaticon.com/512/3082/3082383.png',
                    tag: 'new-order'
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                    navigateToPage('orders');
                };
                
                setTimeout(() => {
                    notification.close();
                }, 10000);
                
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        showNotification(title, body);
                    }
                });
            }
        }

        function playNotificationSound() {
            try {
                if (notificationSound) {
                    notificationSound.currentTime = 0;
                    notificationSound.play();
                }
            } catch (error) {
                console.log('Error playing notification sound:', error);
            }
        }

        // Image Upload Functions
        function switchImageTab(type) {
            currentImageTab = type;
            
            document.querySelectorAll('.upload-tab[data-type="url"], .upload-tab[data-type="cloudinary"]').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.type === type) {
                    tab.classList.add('active');
                }
            });
            
            document.getElementById('urlTab').classList.toggle('active', type === 'url');
            document.getElementById('cloudinaryTab').classList.toggle('active', type === 'cloudinary');
            
            if (type === 'url') {
                document.getElementById('productImage').value = '';
                document.getElementById('urlImagePreview').style.display = 'none';
            } else {
                document.getElementById('cloudinaryImagePreview').style.display = 'none';
                document.getElementById('cloudinaryImageInfo').style.display = 'none';
                document.getElementById('cloudinaryUploadStatus').style.display = 'none';
                document.getElementById('cloudinaryImageUrl').value = '';
            }
        }

        function previewImageFromUrl() {
            const url = document.getElementById('productImage').value;
            if (url) {
                const preview = document.getElementById('urlImagePreview');
                preview.src = url;
                preview.style.display = 'block';
                preview.onerror = function() {
                    showToast('Could not load image from URL', 'error');
                    preview.style.display = 'none';
                };
                document.getElementById('cloudinaryImageUrl').value = url;
            }
        }

        // Setup network detection
        function setupNetworkDetection() {
            const offlineWarning = document.getElementById('offlineWarning');
            
            if (!isOnline) {
                offlineWarning.style.display = 'block';
                showToast('No internet connection. Some features may not work.', 'warning');
            }
            
            window.addEventListener('online', async function() {
                isOnline = true;
                offlineWarning.style.display = 'none';
                showToast('Internet connection restored!', 'success');
                
                if (currentShop) {
                    await loadProducts();
                    await loadOrders();
                    await loadRefunds();
                    await loadDashboardData();
                    showToast('Data refreshed successfully', 'info');
                }
            });
            
            window.addEventListener('offline', function() {
                isOnline = false;
                offlineWarning.style.display = 'block';
                showToast('No internet connection. Working offline mode.', 'warning');
            });
            
            setInterval(() => {
                if (navigator.onLine !== isOnline) {
                    isOnline = navigator.onLine;
                    if (isOnline) {
                        offlineWarning.style.display = 'none';
                        showToast('Internet connection restored!', 'success');
                        if (currentShop) {
                            loadProducts();
                            loadOrders();
                            loadRefunds();
                            loadDashboardData();
                        }
                    } else {
                        offlineWarning.style.display = 'block';
                        showToast('No internet connection.', 'warning');
                    }
                }
            }, 30000);
        }

        // Load Shop Data
        async function loadShopData(shopId) {
            try {
                showLoading(true);
                
                const shopDoc = await db.collection('shops').doc(shopId).get();
                
                if (shopDoc.exists) {
                    currentShop = { id: shopId, ...shopDoc.data() };
                    
                    await loadShopCategories();
                    await loadShopConfig();
                    
                    await loadProducts();
                    await loadOrders();
                    await loadRefunds();
                    updateProfileForm();
                    
                    showAppScreen();
                    showToast('Welcome back to your shop!', 'success');
                    
                    setupOrderListener();
                    
                } else {
                    showToast('Shop profile not found. Please contact admin to create your shop.', 'error');
                    await createShopForUser(shopId);
                }
            } catch (error) {
                console.error("Error loading shop data:", error);
                showToast('Error loading shop data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load shop categories
        async function loadShopCategories() {
            if (!currentShop) return;
            
            try {
                const shopCategoriesDoc = await db.collection('shop_categories').doc(currentShop.id).get();
                
                if (shopCategoriesDoc.exists) {
                    const data = shopCategoriesDoc.data();
                    shopCategories = data.categories || shopCategories;
                } else {
                    await db.collection('shop_categories').doc(currentShop.id).set({
                        categories: shopCategories,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                updateCategoryDropdowns();
                
            } catch (error) {
                console.error('Error loading shop categories:', error);
            }
        }

        // Update category dropdowns
        function updateCategoryDropdowns() {
            const productCategorySelect = document.getElementById('productCategory');
            const shopCategorySelect = document.getElementById('shopCategory');
            
            if (productCategorySelect) {
                const currentValue = productCategorySelect.value;
                productCategorySelect.innerHTML = '';
                
                shopCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1).replace('_', ' ');
                    productCategorySelect.appendChild(option);
                });
                
                const otherOption = document.createElement('option');
                otherOption.value = 'other';
                otherOption.textContent = 'Other (Custom)';
                productCategorySelect.appendChild(otherOption);
                
                productCategorySelect.value = currentValue || 'groceries';
            }
            
            if (shopCategorySelect) {
                const currentValue = shopCategorySelect.value;
                shopCategorySelect.innerHTML = '';
                
                shopCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1).replace('_', ' ');
                    shopCategorySelect.appendChild(option);
                });
                
                const otherOption = document.createElement('option');
                otherOption.value = 'other';
                otherOption.textContent = 'Other (Create New)';
                shopCategorySelect.appendChild(otherOption);
                
                shopCategorySelect.value = currentValue || 'groceries';
            }
        }

        // Add new category
        async function addNewCategory(categoryName) {
            if (!currentShop || !categoryName || categoryName.trim() === '') {
                return false;
            }
            
            try {
                const formattedCategory = categoryName.trim().toLowerCase().replace(/\s+/g, '_');
                
                if (!shopCategories.includes(formattedCategory)) {
                    shopCategories.push(formattedCategory);
                    
                    await db.collection('shop_categories').doc(currentShop.id).update({
                        categories: shopCategories,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    updateCategoryDropdowns();
                    
                    await db.collection('shops').doc(currentShop.id).update({
                        availableCategories: shopCategories,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showToast(`New category "${formattedCategory}" created successfully!`, 'success');
                    return true;
                } else {
                    showToast('Category already exists', 'info');
                    return false;
                }
            } catch (error) {
                console.error('Error adding new category:', error);
                showToast('Error creating category: ' + error.message, 'error');
                return false;
            }
        }

        // Create shop for user if doesn't exist
        async function createShopForUser(userId) {
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                const shopData = {
                    name: user.email.split('@')[0] + ' Shop',
                    email: user.email,
                    category: 'groceries',
                    description: 'Welcome to our shop!',
                    address: 'Address not set',
                    phone: 'Not set',
                    openTime: '09:00',
                    closeTime: '21:00',
                    deliveryType: 'both',
                    couponEnabled: false,
                    couponSettings: null,
                    refundPolicy: {
                        available: true,
                        period: 7,
                        type: 'full_refund',
                        conditions: 'Within 7 days of delivery, product must be unopened and in original condition'
                    },
                    status: 'open',
                    availableCategories: shopCategories,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('shops').doc(userId).set(shopData);
                currentShop = { id: userId, ...shopData };
                
                await db.collection('shop_categories').doc(userId).set({
                    categories: shopCategories,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await createDefaultShopConfig(userId);
                
                showAppScreen();
                showToast('New shop created! Please update your profile.', 'success');
                
                setupOrderListener();
                
            } catch (error) {
                console.log('Error creating shop:', error);
                showToast('Error creating shop: ' + error.message, 'error');
            }
        }

        // Load shop config
        async function loadShopConfig() {
            if (!currentShop) return;
            
            try {
                const configDoc = await db.collection('shop_config').doc(currentShop.id).get();
                
                if (configDoc.exists) {
                    currentShopConfig = { id: configDoc.id, ...configDoc.data() };
                    updateSettingsForm();
                } else {
                    await createDefaultShopConfig(currentShop.id);
                }
            } catch (error) {
                console.error('Error loading shop config:', error);
                await createDefaultShopConfig(currentShop.id);
            }
        }

        // Create default shop config
        async function createDefaultShopConfig(shopId) {
            try {
                const defaultConfig = {
                    shopId: shopId,
                    upiSettings: {
                        upiId: '',
                        qrCodeImage: '',
                        acceptedMethods: {
                            cash: true,
                            upi: true
                        }
                    },
                    couponSettings: {
                        enabled: false,
                        code: '',
                        discountType: 'percentage',
                        value: 10,
                        minOrder: 0,
                        maxDiscount: 0,
                        validUntil: null,
                        usageLimit: 0,
                        active: true,
                        description: ''
                    },
                    restrictions: {
                        maxOrderDistance: 0,
                        minOrderAmount: 0,
                        maxItemsPerOrder: 0,
                        deliveryHours: {
                            start: '09:00',
                            end: '21:00'
                        },
                        blockedCustomers: []
                    },
                    orderSettings: {
                        autoAccept: false,
                        autoReject: {
                            outOfStock: true,
                            afterHours: true,
                            belowMinAmount: true
                        },
                        defaultPrepTime: 30,
                        notifications: {
                            onAccept: true,
                            onReady: true,
                            onDelivery: true
                        }
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('shop_config').doc(shopId).set(defaultConfig);
                currentShopConfig = { id: shopId, ...defaultConfig };
                updateSettingsForm();
                
            } catch (error) {
                console.error('Error creating default shop config:', error);
            }
        }

        // Update settings form with current config
        function updateSettingsForm() {
            if (!currentShopConfig) return;
            
            // UPI Settings
            const upiSettings = currentShopConfig.upiSettings || {};
            document.getElementById('upiId').value = upiSettings.upiId || '';
            
            // QR Code Image
            const qrCodeImage = upiSettings.qrCodeImage || '';
            if (qrCodeImage.includes('cloudinary.com')) {
                switchQRImageTab('cloudinary');
                document.getElementById('cloudinaryQRImageUrl').value = qrCodeImage;
                document.getElementById('qrCodeImageUrl').value = qrCodeImage;
                document.getElementById('cloudinaryQRImagePreview').src = qrCodeImage;
                document.getElementById('cloudinaryQRImagePreview').style.display = 'block';
                document.getElementById('cloudinaryQRImageInfo').style.display = 'block';
            } else if (qrCodeImage) {
                switchQRImageTab('url');
                document.getElementById('qrCodeImageUrl').value = qrCodeImage;
                document.getElementById('qrUrlImagePreview').src = qrCodeImage;
                document.getElementById('qrUrlImagePreview').style.display = 'block';
            }

            const acceptedMethods = upiSettings.acceptedMethods || {};
            document.getElementById('acceptCash').checked = acceptedMethods.cash !== false;
            document.getElementById('acceptUPI').checked = acceptedMethods.upi !== false;

            // Coupon Settings
            const couponEnabled = 
                currentShop?.couponEnabled ?? 
                (currentShopConfig.couponSettings?.enabled || false);

            document.getElementById('couponSystemEnabled').checked = couponEnabled;
            
            // Update status label immediately
            updateCouponStatusLabel(couponEnabled);
            
            const couponSettings = currentShopConfig.couponSettings || {};
            document.getElementById('couponCode').value = couponSettings.code || '';
            document.getElementById('couponDiscountType').value = couponSettings.discountType || 'percentage';
            document.getElementById('couponValue').value = couponSettings.value || '';
            document.getElementById('couponMinOrder').value = couponSettings.minOrder || 0;
            document.getElementById('couponMaxDiscount').value = couponSettings.maxDiscount || 0;
            document.getElementById('couponValidUntil').value = couponSettings.validUntil || '';
            document.getElementById('couponUsageLimit').value = couponSettings.usageLimit || 0;
            document.getElementById('couponActive').value = couponSettings.active ? 'true' : 'false';
            document.getElementById('couponDescription').value = couponSettings.description || '';
            
            // Toggle coupon section based on current state
            toggleCouponSystem();
            
            // Restrictions
            const restrictions = currentShopConfig.restrictions || {};
            document.getElementById('maxOrderDistance').value = restrictions.maxOrderDistance || 0;
            document.getElementById('minOrderAmount').value = restrictions.minOrderAmount || 0;
            document.getElementById('maxItemsPerOrder').value = restrictions.maxItemsPerOrder || 0;
            
            const deliveryHours = restrictions.deliveryHours || {};
            document.getElementById('deliveryStartTime').value = deliveryHours.start || '09:00';
            document.getElementById('deliveryEndTime').value = deliveryHours.end || '21:00';
            
            document.getElementById('blockedCustomers').value = (restrictions.blockedCustomers || []).join(', ');
            
            // Order Settings
            const orderSettings = currentShopConfig.orderSettings || {};
            document.getElementById('autoAcceptOrders').checked = orderSettings.autoAccept || false;
            
            const autoReject = orderSettings.autoReject || {};
            document.getElementById('rejectOutOfStock').checked = autoReject.outOfStock !== false;
            document.getElementById('rejectAfterHours').checked = autoReject.afterHours !== false;
            document.getElementById('rejectBelowMinAmount').checked = autoReject.belowMinAmount !== false;
            
            document.getElementById('defaultPrepTime').value = orderSettings.defaultPrepTime || 30;
            
            const notifications = orderSettings.notifications || {};
            document.getElementById('notifyOnAccept').checked = notifications.onAccept !== false;
            document.getElementById('notifyOnReady').checked = notifications.onReady !== false;
            document.getElementById('notifyOnDelivery').checked = notifications.onDelivery !== false;
        }

        // Update coupon status label
        function updateCouponStatusLabel(enabled) {
            const statusLabel = document.getElementById('couponSystemStatus');
            if (statusLabel) {
                statusLabel.textContent = enabled ? 
                    'Coupon System: Enabled' : 'Coupon System: Disabled';
            }
        }

        // Toggle coupon system
        function toggleCouponSystem() {
            const couponEnabled = document.getElementById('couponSystemEnabled').checked;
            const couponSection = document.getElementById('couponSettingsSection');
            
            updateCouponStatusLabel(couponEnabled);
            
            if (couponEnabled) {
                couponSection.style.display = 'block';
            } else {
                couponSection.style.display = 'none';
            }
        }

        // SAVE UPI SETTINGS - COMPLETELY FIXED FOR REAL-TIME SYNC
        async function saveUPISettings() {
            if (!currentShop) return;
            
            try {
                showLoading(true);
                
                const upiId = document.getElementById('upiId').value.trim();
                
                // Get QR Code Image URL
                let qrCodeImage = '';
                if (currentQRImageTab === 'url') {
                    qrCodeImage = document.getElementById('qrCodeImageUrl').value.trim();
                } else {
                    qrCodeImage = document.getElementById('cloudinaryQRImageUrl').value;
                }
                
                // If empty, use default QR code
                if (!qrCodeImage && upiId) {
                    qrCodeImage = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiId)}`;
                }
                
                const upiSettings = {
                    upiId: upiId,
                    qrCodeImage: qrCodeImage,
                    acceptedMethods: {
                        cash: document.getElementById('acceptCash').checked,
                        upi: document.getElementById('acceptUPI').checked
                    }
                };
                
                // 1. Save to shop_config
                await db.collection('shop_config').doc(currentShop.id).update({
                    upiSettings: upiSettings,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 2. CRITICAL: UPDATE MAIN SHOP DOCUMENT FOR CUSTOMER APP (REAL-TIME SYNC)
                const shopUpdateData = {
                    upiId: upiId,
                    qrCodeImage: qrCodeImage,
                    paymentMethods: {
                        cash: document.getElementById('acceptCash').checked,
                        upi: document.getElementById('acceptUPI').checked
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('shops').doc(currentShop.id).update(shopUpdateData);
                
                // 3. Update local variables
                if (currentShopConfig) {
                    currentShopConfig.upiSettings = upiSettings;
                }
                
                if (currentShop) {
                    currentShop.upiId = upiId;
                    currentShop.qrCodeImage = qrCodeImage;
                    currentShop.paymentMethods = upiSettings.acceptedMethods;
                }
                
                showSettingsSavedMessage('‚úÖ Payment settings saved and synced with customer app!');
                
                // 4. Notify all customers (optional)
                try {
                    await notifyCustomersAboutPaymentUpdate(upiId, qrCodeImage);
                } catch (notifyError) {
                    console.log('Customer notification skipped:', notifyError);
                }
                
            } catch (error) {
                console.error('Error saving UPI settings:', error);
                showToast('Error saving payment settings: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Notify customers about payment update
        async function notifyCustomersAboutPaymentUpdate(upiId, qrCodeImage) {
            try {
                // Get all orders for this shop
                const ordersSnapshot = await db.collection('orders')
                    .where('shopId', '==', currentShop.id)
                    .limit(50)
                    .get();
                
                if (!ordersSnapshot.empty) {
                    const batch = db.batch();
                    
                    ordersSnapshot.forEach(doc => {
                        const orderRef = db.collection('orders').doc(doc.id);
                        batch.update(orderRef, {
                            shopUPIUpdated: true,
                            shopUPIId: upiId,
                            shopQRCode: qrCodeImage,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    
                    await batch.commit();
                    console.log('Notified customers about payment update');
                }
            } catch (error) {
                console.error('Error notifying customers:', error);
            }
        }

        // Save coupon settings - FIXED TO SYNC WITH SHOP DOCUMENT
        async function saveCouponSettings() {
            if (!currentShop) return;
            
            try {
                showLoading(true);
                
                const couponEnabled = document.getElementById('couponSystemEnabled').checked;
                const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
                
                const couponSettings = {
                    enabled: couponEnabled,
                    code: couponCode,
                    discountType: document.getElementById('couponDiscountType').value,
                    value: parseFloat(document.getElementById('couponValue').value) || 0,
                    minOrder: parseFloat(document.getElementById('couponMinOrder').value) || 0,
                    maxDiscount: parseFloat(document.getElementById('couponMaxDiscount').value) || 0,
                    validUntil: document.getElementById('couponValidUntil').value || null,
                    usageLimit: parseInt(document.getElementById('couponUsageLimit').value) || 0,
                    active: document.getElementById('couponActive').value === 'true',
                    description: document.getElementById('couponDescription').value.trim()
                };
                
                // Validation
                if (couponEnabled) {
                    if (!couponCode) {
                        showToast('Please enter coupon code', 'error');
                        return;
                    }
                    
                    if (couponCode.length < 3) {
                        showToast('Coupon code must be at least 3 characters', 'error');
                        return;
                    }
                    
                    if (couponSettings.discountType === 'percentage' && 
                        (couponSettings.value < 1 || couponSettings.value > 100)) {
                        showToast('Percentage discount must be between 1-100%', 'error');
                        return;
                    }
                }
                
                // 1. Save to shop_config
                await db.collection('shop_config').doc(currentShop.id).update({
                    'couponSettings': couponSettings,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 2. UPDATE MAIN SHOP DOCUMENT - THIS IS CRITICAL FOR CUSTOMER APP
                await db.collection('shops').doc(currentShop.id).update({
                    couponEnabled: couponEnabled,
                    couponCode: couponEnabled ? couponCode : '',
                    couponSettings: couponSettings,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 3. Also update currentShop object
                if (currentShop) {
                    currentShop.couponEnabled = couponEnabled;
                    currentShop.couponCode = couponEnabled ? couponCode : '';
                    currentShop.couponSettings = couponSettings;
                }
                
                // 4. Update config
                if (currentShopConfig) {
                    currentShopConfig.couponSettings = couponSettings;
                }
                
                // 5. Update UI
                updateCouponStatusLabel(couponEnabled);
                
                showSettingsSavedMessage('‚úÖ Coupon settings saved and synced with customer app!');
                
            } catch (error) {
                console.error('Error saving coupon settings:', error);
                showToast('Error saving coupon settings: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Save restrictions
        async function saveRestrictions() {
            if (!currentShop) return;
            
            try {
                showLoading(true);
                
                const blockedCustomersText = document.getElementById('blockedCustomers').value.trim();
                const blockedCustomers = blockedCustomersText ? 
                    blockedCustomersText.split(',').map(item => item.trim()).filter(item => item) : [];
                
                const restrictions = {
                    maxOrderDistance: parseInt(document.getElementById('maxOrderDistance').value) || 0,
                    minOrderAmount: parseFloat(document.getElementById('minOrderAmount').value) || 0,
                    maxItemsPerOrder: parseInt(document.getElementById('maxItemsPerOrder').value) || 0,
                    deliveryHours: {
                        start: document.getElementById('deliveryStartTime').value || '09:00',
                        end: document.getElementById('deliveryEndTime').value || '21:00'
                    },
                    blockedCustomers: blockedCustomers
                };
                
                await db.collection('shop_config').doc(currentShop.id).update({
                    'restrictions': restrictions,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (currentShopConfig) {
                    currentShopConfig.restrictions = restrictions;
                }
                
                // Update main shop document
                await db.collection('shops').doc(currentShop.id).update({
                    minOrderAmount: restrictions.minOrderAmount,
                    maxOrderDistance: restrictions.maxOrderDistance,
                    deliveryHours: restrictions.deliveryHours,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showSettingsSavedMessage('‚úÖ Restrictions saved successfully!');
                
            } catch (error) {
                console.error('Error saving restrictions:', error);
                showToast('Error saving restrictions: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Save order settings
        async function saveOrderSettings() {
            if (!currentShop) return;
            
            try {
                showLoading(true);
                
                const orderSettings = {
                    autoAccept: document.getElementById('autoAcceptOrders').checked,
                    autoReject: {
                        outOfStock: document.getElementById('rejectOutOfStock').checked,
                        afterHours: document.getElementById('rejectAfterHours').checked,
                        belowMinAmount: document.getElementById('rejectBelowMinAmount').checked
                    },
                    defaultPrepTime: parseInt(document.getElementById('defaultPrepTime').value) || 30,
                    notifications: {
                        onAccept: document.getElementById('notifyOnAccept').checked,
                        onReady: document.getElementById('notifyOnReady').checked,
                        onDelivery: document.getElementById('notifyOnDelivery').checked
                    }
                };
                
                await db.collection('shop_config').doc(currentShop.id).update({
                    'orderSettings': orderSettings,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (currentShopConfig) {
                    currentShopConfig.orderSettings = orderSettings;
                }
                
                showSettingsSavedMessage('‚úÖ Order settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving order settings:', error);
                showToast('Error saving order settings: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Clear coupon form
        function clearCouponForm() {
            document.getElementById('couponCode').value = '';
            document.getElementById('couponDiscountType').value = 'percentage';
            document.getElementById('couponValue').value = '';
            document.getElementById('couponMinOrder').value = '';
            document.getElementById('couponMaxDiscount').value = '';
            document.getElementById('couponValidUntil').value = '';
            document.getElementById('couponUsageLimit').value = '';
            document.getElementById('couponActive').value = 'true';
            document.getElementById('couponDescription').value = '';
            
            showToast('Coupon form cleared', 'info');
        }

        // Sync shop config with customer app
        async function syncShopConfig() {
            if (!currentShop) return;
            
            try {
                showLoading(true);
                
                // Get current coupon settings
                const couponEnabled = document.getElementById('couponSystemEnabled').checked;
                const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
                
                // Update shop document with all config data
                await db.collection('shops').doc(currentShop.id).update({
                    configUpdated: true,
                    lastConfigSync: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // Also sync specific settings
                    upiId: document.getElementById('upiId').value.trim(),
                    qrCodeImage: currentQRImageTab === 'url' ? 
                        document.getElementById('qrCodeImageUrl').value.trim() : 
                        document.getElementById('cloudinaryQRImageUrl').value,
                    couponEnabled: couponEnabled,
                    couponCode: couponEnabled ? couponCode : '',
                    deliveryHours: {
                        start: document.getElementById('deliveryStartTime').value || '09:00',
                        end: document.getElementById('deliveryEndTime').value || '21:00'
                    },
                    minOrderAmount: parseFloat(document.getElementById('minOrderAmount').value) || 0
                });
                
                showSettingsSavedMessage('‚úÖ Settings synced with customer app!');
                
            } catch (error) {
                console.error('Error syncing shop config:', error);
                showToast('Error syncing settings: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Export shop data
        async function exportShopData() {
            if (!currentShop) return;
            
            try {
                showLoading(true);
                
                const exportData = {
                    shop: currentShop,
                    config: currentShopConfig,
                    products: products,
                    orders: orders,
                    refunds: refunds,
                    exportDate: new Date().toISOString()
                };
                
                const jsonData = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `shop_export_${currentShop.id}_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSettingsSavedMessage('‚úÖ Data exported successfully!');
                
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('Error exporting data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Reset settings to defaults
        async function resetSettings() {
            if (!confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                return;
            }
            
            try {
                showLoading(true);
                
                await createDefaultShopConfig(currentShop.id);
                showSettingsSavedMessage('‚úÖ Settings reset to defaults!');
                
            } catch (error) {
                console.error('Error resetting settings:', error);
                showToast('Error resetting settings: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Show settings saved message with animation
        function showSettingsSavedMessage(message) {
            // Create a special success message
            const successMessage = `
                <div style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #28a745, #20c997);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 10px;
                    box-shadow: 0 5px 20px rgba(40, 167, 69, 0.3);
                    z-index: 4000;
                    animation: settingsSaved 2s ease-in-out;
                    text-align: center;
                    min-width: 300px;
                ">
                    <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <h3 style="margin: 0 0 10px 0;">‚úÖ Settings Saved!</h3>
                    <p style="margin: 0; font-size: 1rem;">${message}</p>
                </div>
            `;
            
            // Add animation style
            const style = document.createElement('style');
            style.textContent = `
                @keyframes settingsSaved {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    20% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
                    40% { transform: translate(-50%, -50%) scale(1); }
                    80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            document.head.appendChild(style);
            
            // Show message
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = successMessage;
            document.body.appendChild(messageDiv);
            
            // Remove after animation
            setTimeout(() => {
                messageDiv.remove();
                style.remove();
                showToast(message, 'success');
            }, 2000);
        }

        // Authentication
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            try {
                showLoading(true);
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await loadShopData(user.uid);
                
            } catch (error) {
                let errorMessage = 'Login failed. ';
                
                switch(error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address format.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Check your internet connection.';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showToast(errorMessage, 'error');
            } finally {
                showLoading(false);
            }
        }

        function showForgotPassword() {
            const email = prompt('Enter your email address to reset password:');
            if (email && email.includes('@')) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        alert('üìß Password reset email sent! Check your inbox and spam folder.');
                    })
                    .catch(error => {
                        alert('‚ùå Error: ' + error.message);
                    });
            } else if (email) {
                alert('‚ö†Ô∏è Please enter a valid email address.');
            }
        }

        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('appScreen').style.display = 'none';
            
            if (ordersListener) {
                ordersListener();
                ordersListener = null;
            }
        }

        function showAppScreen() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            navigateToPage('dashboard');
        }

        function logout() {
            if (ordersListener) {
                ordersListener();
                ordersListener = null;
            }
            
            auth.signOut();
            showAuthScreen();
            showToast('Logged out successfully', 'info');
        }

        // Navigation
        function navigateToPage(page) {
            document.querySelectorAll('.content-page').forEach(pageElement => {
                pageElement.classList.remove('active');
            });
            
            const pageElement = document.getElementById(page + 'Page');
            if (pageElement) {
                pageElement.classList.add('active');
                
                switch(page) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'products':
                        loadProducts();
                        break;
                    case 'orders':
                        loadOrders();
                        break;
                    case 'refunds':
                        loadRefunds();
                        break;
                    case 'settings':
                        loadShopConfig();
                        break;
                }
            }
        }

        // Loading Spinner
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.style.display = show ? 'block' : 'none';
            }
        }

        // Dashboard Functions
        async function loadDashboardData() {
            if (!currentShop) return;
            
            try {
                document.getElementById('totalProducts').textContent = products.length;
                
                const pendingOrdersCount = orders.filter(order => order.status === 'pending').length;
                document.getElementById('pendingOrders').textContent = pendingOrdersCount;
                
                const totalRevenue = orders.filter(o => o.status === 'delivered' || o.status === 'picked_up')
                    .reduce((sum, order) => sum + (order.total || order.totalAmount || 0), 0);
                document.getElementById('totalRevenue').textContent = `‚Çπ${totalRevenue.toFixed(2)}`;
                
                const pendingRefundsCount = refunds.filter(refund => refund.status === 'pending').length;
                document.getElementById('pendingRefunds').textContent = pendingRefundsCount;
                
                updateDashboardOrdersSummary();
                
            } catch (error) {
                console.error("Error loading dashboard:", error);
            }
        }

        // Update dashboard orders summary
        function updateDashboardOrdersSummary() {
            const statsContainer = document.getElementById('dashboardOrdersStats');
            
            if (!statsContainer) return;
            
            const pendingCount = orders.filter(o => o.status === 'pending').length;
            const confirmedCount = orders.filter(o => o.status === 'confirmed').length;
            const preparingCount = orders.filter(o => o.status === 'preparing').length;
            const deliveredCount = orders.filter(o => o.status === 'delivered').length;
            const pickedUpCount = orders.filter(o => o.status === 'picked_up').length;
            const cancelledCount = orders.filter(o => o.status === 'cancelled' || o.status === 'rejected').length;
            
            statsContainer.innerHTML = `
                <div class="dashboard-stat pending">
                    <span class="dashboard-stat-value">${pendingCount}</span>
                    <span class="dashboard-stat-label">Pending Orders</span>
                </div>
                <div class="dashboard-stat confirmed">
                    <span class="dashboard-stat-value">${confirmedCount}</span>
                    <span class="dashboard-stat-label">Confirmed</span>
                </div>
                <div class="dashboard-stat preparing">
                    <span class="dashboard-stat-value">${preparingCount}</span>
                    <span class="dashboard-stat-label">Preparing</span>
                </div>
                <div class="dashboard-stat delivered">
                    <span class="dashboard-stat-value">${deliveredCount + pickedUpCount}</span>
                    <span class="dashboard-stat-label">Completed</span>
                </div>
                <div class="dashboard-stat">
                    <span class="dashboard-stat-value">${cancelledCount}</span>
                    <span class="dashboard-stat-label">Cancelled/Rejected</span>
                </div>
            `;
        }

        // Product Management
        async function loadProducts() {
            if (!currentShop) return;
            
            try {
                showLoading(true);
                
                const snapshot = await db.collection('products')
                    .where('shopId', '==', currentShop.id)
                    .get();
                
                products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                
                renderProducts();
                
            } catch (error) {
                console.error("Error loading products:", error);
                showToast('Error loading products: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderProducts() {
            const productsList = document.getElementById('productsList');
            
            if (products.length === 0) {
                productsList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <i class="fas fa-box-open" style="font-size: 4rem; color: #ccc; margin-bottom: 1rem;"></i>
                        <h3 style="color: #666; margin-bottom: 1rem;">No Products Yet</h3>
                        <p style="color: #999; margin-bottom: 2rem;">Add your first product to start selling</p>
                        <button class="btn btn-primary" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i> Add Your First Product
                        </button>
                    </div>
                `;
                return;
            }
            
            let productsHtml = '';
            products.forEach((product) => {
                let stockClass = 'in-stock';
                let stockText = '';
                let stockIcon = 'check-circle';
                
                if (product.stock > 10) {
                    stockClass = 'in-stock';
                    stockText = `${product.stock} in stock`;
                    stockIcon = 'check-circle';
                } else if (product.stock > 0) {
                    stockClass = 'low-stock';
                    stockText = `Low stock (${product.stock})`;
                    stockIcon = 'exclamation-circle';
                } else {
                    stockClass = 'out-of-stock';
                    stockText = 'Out of stock';
                    stockIcon = 'times-circle';
                }

                let discountBadge = '';
                if (product.mrp && product.mrp > product.price) {
                    const discountPercent = Math.round(((product.mrp - product.price) / product.mrp) * 100);
                    if (discountPercent > 0) {
                        discountBadge = `<span class="product-discount">${discountPercent}% OFF</span>`;
                    }
                }

                const productImage = product.image || 'https://cdn-icons-png.flaticon.com/512/3148/3148829.png';

                const refundAvailable = product.refundAvailable !== undefined ? product.refundAvailable : true;
                const refundType = product.refundType || 'use_shop_default';
                const refundConditions = product.refundConditions || '';
                
                let refundBadge = '';
                if (!refundAvailable) {
                    refundBadge = '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">No Refund</span>';
                } else if (refundType === 'no_refund') {
                    refundBadge = '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">Non-Returnable</span>';
                } else {
                    refundBadge = '<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">Refund Available</span>';
                }

                productsHtml += `
                    <div class="product-card">
                        <div class="product-image-container">
                            <img src="${productImage}" 
                                 alt="${product.name}" class="product-image">
                            <span class="product-badge">${product.category || 'Product'}</span>
                        </div>
                        <div class="product-details">
                            <h3 class="product-title">${product.name} ${refundBadge}</h3>
                            
                            <div class="product-price-row">
                                <span class="product-price">‚Çπ${parseFloat(product.price || 0).toFixed(2)}</span>
                                ${product.mrp && product.mrp > product.price ? 
                                    `<span class="product-mrp">‚Çπ${parseFloat(product.mrp).toFixed(2)}</span>` : ''}
                                ${discountBadge}
                            </div>
                            
                            <div class="product-stock ${stockClass}">
                                <i class="fas fa-${stockIcon}"></i>
                                ${stockText}
                            </div>
                            
                            ${product.description ? `<p style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">${product.description.substring(0, 60)}${product.description.length > 60 ? '...' : ''}</p>` : ''}
                            
                            ${refundConditions ? `<p style="color: #f39c12; font-size: 0.8rem; margin-top: 0.5rem;"><i class="fas fa-info-circle"></i> ${refundConditions.substring(0, 50)}${refundConditions.length > 50 ? '...' : ''}</p>` : ''}
                            
                            <div class="product-actions">
                                <button class="btn-edit-product" onclick="editProduct('${product.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn-add-product" onclick="deleteProduct('${product.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            productsList.innerHTML = productsHtml;
        }

        // Product Modal Functions
        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('cloudinaryImageUrl').value = '';
            document.getElementById('urlImagePreview').style.display = 'none';
            document.getElementById('cloudinaryImagePreview').style.display = 'none';
            document.getElementById('cloudinaryImageInfo').style.display = 'none';
            document.getElementById('cloudinaryUploadStatus').style.display = 'none';
            document.getElementById('customCategoryName').value = '';
            document.getElementById('customCategoryInput').style.display = 'none';
            
            document.getElementById('productRefundAvailable').checked = true;
            document.getElementById('productRefundPeriod').value = 7;
            document.getElementById('productRefundType').value = 'use_shop_default';
            document.getElementById('productRefundConditions').value = '';
            document.getElementById('productRefundDetails').style.display = 'block';
            
            switchImageTab('url');
            document.getElementById('productModal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('editProductId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category || 'groceries';
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productMrp').value = product.mrp || '';
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productDescription').value = product.description || '';
            
            const refundAvailable = product.refundAvailable !== undefined ? product.refundAvailable : true;
            document.getElementById('productRefundAvailable').checked = refundAvailable;
            document.getElementById('productRefundPeriod').value = product.refundPeriod || 7;
            document.getElementById('productRefundType').value = product.refundType || 'use_shop_default';
            document.getElementById('productRefundConditions').value = product.refundConditions || '';
            document.getElementById('productRefundDetails').style.display = refundAvailable ? 'block' : 'none';
            
            const category = product.category || 'groceries';
            if (!shopCategories.includes(category) && category !== 'other') {
                document.getElementById('productCategory').value = 'other';
                document.getElementById('customCategoryName').value = category;
                document.getElementById('customCategoryInput').style.display = 'block';
            }
            
            if (product.image) {
                if (product.image.includes('cloudinary.com') || product.image.includes('res.cloudinary.com')) {
                    document.getElementById('cloudinaryImageUrl').value = product.image;
                    switchImageTab('cloudinary');
                    const preview = document.getElementById('cloudinaryImagePreview');
                    preview.src = product.image;
                    preview.style.display = 'block';
                    document.getElementById('cloudinaryImageInfo').style.display = 'block';
                } else {
                    switchImageTab('url');
                    document.getElementById('productImage').value = product.image;
                    const preview = document.getElementById('urlImagePreview');
                    preview.src = product.image;
                    preview.style.display = 'block';
                }
            } else {
                switchImageTab('url');
            }
            
            document.getElementById('productModal').classList.add('active');
        }

        async function saveProduct() {
            if (!currentShop || !currentShop.name) {
                showToast('Shop information not loaded. Please refresh page.', 'error');
                return;
            }
            
            const productId = document.getElementById('editProductId').value;
            const productName = document.getElementById('productName').value.trim();
            const productPrice = parseFloat(document.getElementById('productPrice').value);
            const productMrp = parseFloat(document.getElementById('productMrp').value) || productPrice;
            const productStock = parseInt(document.getElementById('productStock').value);
            
            if (!productName) {
                showToast('Product name is required', 'error');
                return;
            }
            
            if (isNaN(productPrice) || productPrice < 0) {
                showToast('Please enter a valid price', 'error');
                return;
            }
            
            if (isNaN(productStock) || productStock < 0) {
                showToast('Please enter a valid stock quantity', 'error');
                return;
            }
            
            let category = document.getElementById('productCategory').value;
            if (category === 'other') {
                const customCategory = document.getElementById('customCategoryName').value.trim();
                if (!customCategory) {
                    showToast('Please enter custom category name', 'error');
                    return;
                }
                
                const success = await addNewCategory(customCategory);
                if (success) {
                    category = customCategory.toLowerCase().replace(/\s+/g, '_');
                } else {
                    category = 'other';
                }
            }
            
            let imageUrl = '';
            if (currentImageTab === 'url') {
                imageUrl = document.getElementById('productImage').value.trim();
                if (!imageUrl) {
                    imageUrl = document.getElementById('cloudinaryImageUrl').value;
                }
            } else {
                imageUrl = document.getElementById('cloudinaryImageUrl').value;
            }
            
            if (!imageUrl) {
                imageUrl = 'https://cdn-icons-png.flaticon.com/512/3148/3148829.png';
            }
            
            const refundAvailable = document.getElementById('productRefundAvailable').checked;
            const refundPeriod = parseInt(document.getElementById('productRefundPeriod').value) || 7;
            const refundType = document.getElementById('productRefundType').value;
            const refundConditions = document.getElementById('productRefundConditions').value.trim();
            
            const productData = {
                name: productName,
                category: category,
                price: productPrice,
                mrp: productMrp,
                stock: productStock,
                description: document.getElementById('productDescription').value.trim(),
                image: imageUrl,
                shopId: currentShop.id,
                shopName: currentShop.name,
                refundAvailable: refundAvailable,
                refundPeriod: refundAvailable ? refundPeriod : null,
                refundType: refundAvailable ? refundType : null,
                refundConditions: refundAvailable ? refundConditions : '',
                isAvailable: true,
                status: 'active',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                showLoading(true);
                if (productId) {
                    await db.collection('products').doc(productId).update(productData);
                    showToast('Product updated successfully!', 'success');
                } else {
                    productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('products').add(productData);
                    showToast('Product added successfully!', 'success');
                }
                
                closeProductModal();
                await loadProducts();
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error saving product:', error);
                showToast('Error saving product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            try {
                showLoading(true);
                await db.collection('products').doc(productId).delete();
                showToast('Product deleted successfully!', 'success');
                await loadProducts();
                await loadDashboardData();
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('Error deleting product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== ORDER MANAGEMENT ====================
        
        async function loadOrders() {
            if (!currentShop) return;
            
            try {
                showLoading(true);
                orders = [];
                
                try {
                    const allOrdersSnapshot = await db.collection('orders')
                        .where('shopId', '==', currentShop.id)
                        .orderBy('createdAt', 'desc')
                        .limit(100)
                        .get();
                    
                    allOrdersSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.shopId === currentShop.id) {
                            const orderIdFromCustomer = data.orderId || doc.id;
                            const customerId = data.customerId || data.userId || (data.user && data.user.id);
                            
                            if (!orders.find(o => o.firestoreId === doc.id)) {
                                orders.push({ 
                                    id: orderIdFromCustomer,
                                    firestoreId: doc.id,
                                    customerId: customerId,
                                    ...data,
                                    shortId: generateShortOrderId(orderIdFromCustomer)
                                });
                            }
                        }
                    });
                } catch (error) {
                    console.log('Query error:', error.message);
                    
                    try {
                        const allOrdersSnapshot = await db.collection('orders')
                            .where('shopId', '==', currentShop.id)
                            .get();
                        
                        allOrdersSnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.shopId === currentShop.id) {
                                const orderIdFromCustomer = data.orderId || doc.id;
                                const customerId = data.customerId || data.userId || (data.user && data.user.id);
                                
                                if (!orders.find(o => o.firestoreId === doc.id)) {
                                    orders.push({ 
                                        id: orderIdFromCustomer,
                                        firestoreId: doc.id,
                                        customerId: customerId,
                                        ...data,
                                        shortId: generateShortOrderId(orderIdFromCustomer)
                                    });
                                }
                            }
                        });
                        
                        orders.sort((a, b) => {
                            const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                            const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                            return dateB - dateA;
                        });
                        
                    } catch (secondError) {
                        console.error('Alternative query also failed:', secondError);
                    }
                }
                
                await loadOrderItemsForOrders();
                await updateOrdersWithRefundInfo();
                
                filterOrders();
                updateOrdersSummary();
                updateDashboardOrdersSummary();
                
            } catch (error) {
                console.error("Error loading orders:", error);
                showToast('Error loading orders: ' + error.message, 'error');
                orders = [];
                filteredOrders = [];
                renderOrders();
            } finally {
                showLoading(false);
            }
        }

        // Load order items for all orders
        async function loadOrderItemsForOrders() {
            if (!currentShop || orders.length === 0) return;
            
            try {
                for (let order of orders) {
                    try {
                        const orderItemsSnapshot = await db.collection('orderItems')
                            .where('orderId', '==', order.id)
                            .where('shopId', '==', currentShop.id)
                            .get();
                        
                        if (!orderItemsSnapshot.empty) {
                            const items = [];
                            orderItemsSnapshot.forEach(doc => {
                                items.push({ id: doc.id, ...doc.data() });
                            });
                            order.orderItems = items;
                        } else {
                            order.orderItems = order.items || [];
                        }
                    } catch (error) {
                        console.error('Error loading order items:', error);
                        order.orderItems = order.items || [];
                    }
                }
            } catch (error) {
                console.error('Error in loadOrderItemsForOrders:', error);
            }
        }

        function generateShortOrderId(orderId) {
            if (!orderId) return 'N/A';
            return orderId.substring(orderId.length - 6).toUpperCase();
        }

        // Filter orders by status
        function filterOrders() {
            const filterValue = document.getElementById('orderStatusFilter').value;
            
            if (filterValue === 'all') {
                filteredOrders = [...orders];
            } else {
                filteredOrders = orders.filter(order => order.status === filterValue);
            }
            
            renderOrders();
        }

        function updateOrdersSummary() {
            const pendingCount = orders.filter(o => o.status === 'pending').length;
            const confirmedCount = orders.filter(o => o.status === 'confirmed').length;
            const preparingCount = orders.filter(o => o.status === 'preparing').length;
            
            document.getElementById('pendingSummary').textContent = pendingCount;
            document.getElementById('confirmedSummary').textContent = confirmedCount;
            document.getElementById('preparingSummary').textContent = preparingCount;
            document.getElementById('totalSummary').textContent = orders.length;
            
            const badges = document.querySelectorAll('.orders-badge, .badge');
            badges.forEach(badge => {
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            });
        }

        function renderOrders() {
            const ordersList = document.getElementById('ordersList');
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem;">
                            <i class="fas fa-shopping-bag" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                            <h4 style="color: #666;">No Orders Found</h4>
                            <p style="color: #999;">No orders match the current filter</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let ordersHtml = '';
            
            filteredOrders.forEach(order => {
                try {
                    const orderDate = order.createdAt ? 
                        (order.createdAt.toDate ? order.createdAt.toDate() : new Date(order.createdAt)).toLocaleDateString('en-IN', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 
                        'Recently';
                    
                    let statusText = '';
                    let statusClass = '';
                    
                    const isPickupOnly = currentShop.deliveryType === 'pickup_only';
                    
                    switch(order.status) {
                        case 'pending':
                            statusText = 'Pending';
                            statusClass = 'status-text status-pending';
                            break;
                        case 'confirmed':
                            statusText = order.isPartialOrder ? 'Partially Accepted' : 'Confirmed';
                            statusClass = 'status-text status-confirmed';
                            break;
                        case 'preparing':
                            statusText = order.isPartialOrder ? 'Preparing (Partial)' : 'Preparing';
                            statusClass = 'status-text status-preparing';
                            break;
                        case 'packed':
                            statusText = isPickupOnly ? 'Packed' : 'Preparing';
                            statusClass = 'status-text status-packed';
                            break;
                        case 'ready_for_pickup':
                            statusText = 'Ready for Pickup';
                            statusClass = 'status-text status-ready_for_pickup';
                            break;
                        case 'picked_up':
                            statusText = 'Picked Up';
                            statusClass = 'status-text status-picked_up';
                            break;
                        case 'dispatched':
                            statusText = order.isPartialOrder ? 'Dispatched (Partial)' : 'Dispatched';
                            statusClass = 'status-text status-dispatched';
                            break;
                        case 'out_for_delivery':
                            statusText = 'Out for Delivery';
                            statusClass = 'status-text status-out_for_delivery';
                            break;
                        case 'delivered':
                            statusText = order.isPartialOrder ? 'Delivered (Partial)' : 'Delivered';
                            statusClass = 'status-text status-delivered';
                            break;
                        case 'cancelled':
                            statusText = 'Cancelled';
                            statusClass = 'status-text status-cancelled';
                            break;
                        case 'rejected':
                            statusText = 'Rejected';
                            statusClass = 'status-text status-rejected';
                            break;
                        default:
                            statusText = order.status || 'Unknown';
                            statusClass = 'status-text';
                    }
                    
                    let itemsDisplay = '';
                    let partialBadge = '';
                    
                    if (order.isPartialOrder) {
                        partialBadge = ' <span class="badge bg-warning">Partial</span>';
                        
                        const acceptedItems = order.acceptedItems || [];
                        const rejectedItems = order.rejectedItems || [];
                        
                        let acceptedText = '';
                        let rejectedText = '';
                        
                        if (acceptedItems.length > 0) {
                            acceptedText = acceptedItems.map(item => 
                                `${item.quantity || 1}x ${item.name || 'Item'} ‚úì`
                            ).join(', ');
                        }
                        
                        if (rejectedItems.length > 0) {
                            rejectedText = rejectedItems.map(item => 
                                `${item.quantity || 1}x ${item.name || 'Item'} ‚úó`
                            ).join(', ');
                        }
                        
                        if (acceptedText && rejectedText) {
                            itemsDisplay = `Accepted: ${acceptedText} | Not Available: ${rejectedText}`;
                        } else if (acceptedText) {
                            itemsDisplay = acceptedText;
                        } else if (rejectedText) {
                            itemsDisplay = `Rejected: ${rejectedText}`;
                        }
                    } else if (order.items && Array.isArray(order.items)) {
                        const itemMap = {};
                        order.items.forEach(item => {
                            const itemName = item.name || item.productName || 'Item';
                            if (!itemMap[itemName]) {
                                itemMap[itemName] = { quantity: 0, price: item.price || 0 };
                            }
                            itemMap[itemName].quantity += (item.quantity || 1);
                        });
                        
                        itemsDisplay = Object.entries(itemMap)
                            .map(([name, data]) => `${data.quantity}x ${name}`)
                            .join(', ');
                    } else if (order.productName) {
                        itemsDisplay = `${order.quantity || 1}x ${order.productName}`;
                    } else {
                        itemsDisplay = 'No items';
                    }
                    
                    const customerName = order.customerName || order.name || order.userName || 
                                       (order.user && order.user.name) || 
                                       (order.customer && order.customer.name) || 
                                       'Customer';
                    
                    const customerPhone = order.customerPhone || order.phone || 
                                        (order.user && order.user.phone) ||
                                        (order.customer && order.customer.phone) || 
                                        'N/A';
                    
                                        // IMPROVED ADDRESS EXTRACTION
                                        let customerAddress = 'N/A';
                    
                    if (order.address && typeof order.address === 'object') {
                        const addr = order.address;
                        const parts = [];
                    
                        if (addr.details) parts.push(addr.details);
                        if (addr.landmark) parts.push(addr.landmark);
                        if (addr.city) parts.push(addr.city);
                        if (addr.pincode) parts.push(addr.pincode);
                    
                        if (parts.length > 0) {
                            customerAddress = parts.join(', ');
                        }
                    }

                    } else if (order.customerAddress && typeof order.customerAddress === 'string') {
                        customerAddress = order.customerAddress;
                    } else if (order.user && order.user.address) {
                        if (typeof order.user.address === 'string') {
                            customerAddress = order.user.address;
                        } else if (typeof order.user.address === 'object') {
                            const addr = order.user.address;
                            const parts = [];
                            if (addr.street) parts.push(addr.street);
                            if (addr.area) parts.push(addr.area);
                            if (addr.city) parts.push(addr.city);
                            if (addr.state) parts.push(addr.state);
                            if (addr.pincode) parts.push(addr.pincode);
                            if (parts.length > 0) customerAddress = parts.join(', ');
                        }
                    } else if (order.customer && order.customer.address) {
                        if (typeof order.customer.address === 'string') {
                            customerAddress = order.customer.address;
                        } else if (typeof order.customer.address === 'object') {
                            const addr = order.customer.address;
                            const parts = [];
                            if (addr.street) parts.push(addr.street);
                            if (addr.area) parts.push(addr.area);
                            if (addr.city) parts.push(addr.city);
                            if (addr.state) parts.push(addr.state);
                            if (addr.pincode) parts.push(addr.pincode);
                            if (parts.length > 0) customerAddress = parts.join(', ');
                        }
                    } else if (order.deliveryAddress && typeof order.deliveryAddress === 'string') {
                        customerAddress = order.deliveryAddress;
                    }
                    
                    let paymentText = '';
                    const paymentMethod = order.paymentMethod || 'cod';
                    let paymentStatus = order.paymentStatus || 'pending';
                    
                    if ((order.status === 'delivered' || order.status === 'picked_up') && paymentStatus === 'pending') {
                        paymentStatus = 'paid';
                    }
                    
                    if (paymentMethod === 'cod') {
                        if (paymentStatus === 'paid') {
                            paymentText = `<span class="payment-text payment-cod-paid">COD - PAID</span>`;
                        } else {
                            paymentText = `<span class="payment-text payment-cod-unpaid">COD - UNPAID</span>`;
                        }
                    } else if (paymentMethod === 'qr' || paymentMethod === 'online') {
                        if (paymentStatus === 'paid') {
                            if (order.utrNumber) {
                                paymentText = `<span class="payment-text payment-online-paid">QR - UTR: ${order.utrNumber}</span>`;
                            } else {
                                paymentText = `<span class="payment-text payment-online-paid">QR - PAID</span>`;
                            }
                        } else {
                            paymentText = `<span class="payment-text payment-online-unpaid">QR - UNPAID</span>`;
                        }
                    } else {
                        if (paymentStatus === 'paid') {
                            paymentText = `<span class="payment-text payment-paid">PAID</span>`;
                        } else {
                            paymentText = `<span class="payment-text payment-unpaid">UNPAID</span>`;
                        }
                    }
                    
                    let orderAmount = 0;
                    if (order.isPartialOrder) {
                        orderAmount = order.acceptedTotal || order.total || 0;
                    } else {
                        orderAmount = order.total || order.totalAmount || 0;
                    }
                    
                    let couponBadge = '';
                    if (order.couponCode) {
                        const couponDiscount = order.couponDiscount || 0;
                        couponBadge = ` <span class="badge bg-info" title="Coupon: ${order.couponCode}, Discount: ‚Çπ${couponDiscount.toFixed(2)}">Coupon Applied</span>`;
                    }
                    
                    let actionButtons = '';
                    const firestoreId = order.firestoreId || order.id;
                    
                    const hasRefund = order.refundStatus && order.refundStatus !== 'none';
                    
                    if (order.status === 'pending') {
                        actionButtons = `
                            <div class="action-buttons">
                                <button class="action-btn btn-success" onclick="updateOrderStatus('${firestoreId}', 'confirmed')">
                                    <i class="fas fa-check"></i> Accept All
                                </button>
                                <button class="action-btn btn-warning" onclick="showPartialOrderModal('${firestoreId}')">
                                    <i class="fas fa-check-double"></i> Accept Partial
                                </button>
                                <button class="action-btn btn-danger" onclick="updateOrderStatus('${firestoreId}', 'rejected')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        `;
                    } else if (order.status === 'confirmed') {
                        actionButtons = `
                            <button class="action-btn btn-info" onclick="updateOrderStatus('${firestoreId}', 'preparing')">
                                <i class="fas fa-utensils"></i> Start Preparing
                            </button>
                        `;
                    } else if (order.status === 'preparing') {
                        if (isPickupOnly) {
                            actionButtons = `
                                <button class="action-btn btn-warning" onclick="updateOrderStatus('${firestoreId}', 'packed')">
                                    <i class="fas fa-box"></i> Mark as Packed
                                </button>
                            `;
                        } else {
                            actionButtons = `
                                <button class="action-btn btn-warning" onclick="updateOrderStatus('${firestoreId}', 'dispatched')">
                                    <i class="fas fa-shipping-fast"></i> Mark as Dispatched
                                </button>
                            `;
                        }
                    } else if (order.status === 'packed') {
                        actionButtons = `
                            <button class="action-btn btn-success" onclick="updateOrderStatus('${firestoreId}', 'ready_for_pickup')">
                                <i class="fas fa-check-circle"></i> Ready for Pickup
                            </button>
                        `;
                    } else if (order.status === 'ready_for_pickup') {
                        actionButtons = `
                            <button class="action-btn btn-success" onclick="updateOrderStatus('${firestoreId}', 'picked_up')">
                                <i class="fas fa-check-circle"></i> Mark as Picked Up
                            </button>
                        `;
                    } else if (order.status === 'dispatched') {
                        actionButtons = `
                            <button class="action-btn btn-success" onclick="updateOrderStatus('${firestoreId}', 'out_for_delivery')">
                                <i class="fas fa-truck"></i> Out for Delivery
                            </button>
                        `;
                    } else if (order.status === 'out_for_delivery') {
                        actionButtons = `
                            <button class="action-btn btn-success" onclick="updateOrderStatus('${firestoreId}', 'delivered')">
                                <i class="fas fa-check-circle"></i> Mark as Delivered
                            </button>
                        `;
                    } else if (order.status === 'delivered' || order.status === 'picked_up') {
                        if (paymentStatus === 'pending') {
                            actionButtons = `
                                <button class="action-btn btn-success" onclick="markAsPaid('${firestoreId}', ${orderAmount})">
                                    <i class="fas fa-money-bill-wave"></i> Mark as Paid
                                </button>
                            `;
                        } else {
                            actionButtons = `<span class="text-success"><i class="fas fa-check-circle"></i> Completed</span>`;
                        }
                        
                        if (!hasRefund || order.refundStatus === 'none') {
                            actionButtons += `
                                <button class="action-btn btn-warning mt-1" onclick="showInitiateRefundModal('${firestoreId}')">
                                    <i class="fas fa-exchange-alt"></i> Initiate Refund
                                </button>
                            `;
                        }
                    } else if (order.status === 'cancelled' || order.status === 'rejected') {
                        actionButtons = `<span class="text-danger"><i class="fas fa-ban"></i> ${order.status === 'cancelled' ? 'Cancelled' : 'Rejected'}</span>`;
                    }
                    
                    if (order.status === 'preparing' || order.status === 'packed') {
                        actionButtons += `
                            <button class="action-btn btn-info mt-1" onclick="showOrderItemsModal('${firestoreId}')">
                                <i class="fas fa-clipboard-list"></i> Manage Items
                            </button>
                        `;
                    }
                    
                    if (hasRefund) {
                        let refundStatusText = '';
                        let refundStatusClass = '';
                        switch(order.refundStatus) {
                            case 'pending':
                                refundStatusText = 'Refund Pending';
                                refundStatusClass = 'status-text status-refund_pending';
                                break;
                            case 'completed':
                                refundStatusText = 'Refunded';
                                refundStatusClass = 'status-text status-refund_completed';
                                break;
                            case 'rejected':
                                refundStatusText = 'Refund Rejected';
                                refundStatusClass = 'status-text status-refund_rejected';
                                break;
                        }
                        actionButtons += `
                            <div class="mt-1">
                                <span class="${refundStatusClass}">${refundStatusText}</span>
                            </div>
                        `;
                    }
                    
                    actionButtons += `
                        <button class="action-btn btn-info mt-1" onclick="viewOrderDetails('${firestoreId}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    `;
                    
                    ordersHtml += `
                        <tr data-order-id="${order.id}" class="${order.status === 'pending' ? 'table-warning' : ''}">
                            <td>
                                <strong title="Full ID: ${order.id}">#${order.shortId || generateShortOrderId(order.id)}</strong>
                                ${partialBadge}${couponBadge}
                            </td>
                            <td>
                                <div><strong>${customerName}</strong></div>
                                <small class="text-muted">${customerPhone}</small>
                                <small class="text-muted d-block">${customerAddress}</small>
                            </td>
                            <td title="${itemsDisplay}">
                                ${itemsDisplay.length > 30 ? itemsDisplay.substring(0, 30) + '...' : itemsDisplay}
                            </td>
                            <td><strong>‚Çπ${orderAmount.toFixed(2)}</strong></td>
                            <td>
                                <span class="${statusClass}">${statusText}</span>
                            </td>
                            <td>${paymentText}</td>
                            <td>${orderDate}</td>
                            <td>${actionButtons}</td>
                        </tr>
                    `;
                    
                } catch (error) {
                    console.error('Error rendering order:', order, error);
                }
            });
            
            ordersList.innerHTML = ordersHtml;
        }

        async function updateOrderStatus(firestoreId, newStatus) {
            if (!confirm(`Are you sure you want to ${newStatus} this order?`)) return;
            
            try {
                showLoading(true);
                
                const updateData = {
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (newStatus === 'preparing') {
                    updateData.preparationStartTime = firebase.firestore.FieldValue.serverTimestamp();
                } else if (newStatus === 'packed') {
                    updateData.packedTime = firebase.firestore.FieldValue.serverTimestamp();
                } else if (newStatus === 'ready_for_pickup') {
                    updateData.readyForPickupTime = firebase.firestore.FieldValue.serverTimestamp();
                } else if (newStatus === 'out_for_delivery') {
                    updateData.outForDeliveryTime = firebase.firestore.FieldValue.serverTimestamp();
                } else if (newStatus === 'delivered' || newStatus === 'picked_up') {
                    updateData.deliveredTime = firebase.firestore.FieldValue.serverTimestamp();
                    updateData.paymentStatus = 'paid';
                }
                
                await db.collection('orders').doc(firestoreId).update(updateData);
                
                showToast(`Order ${newStatus.replace('_', ' ')}!`, 'success');
                await loadOrders();
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error updating order:', error);
                showToast('Error updating order: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function markAsPaid(firestoreId, amount) {
            if (!confirm(`Mark order #${firestoreId.substring(0, 6)} as paid? Amount: ‚Çπ${amount.toFixed(2)}`)) return;
            
            try {
                showLoading(true);
                await db.collection('orders').doc(firestoreId).update({
                    paymentStatus: 'paid',
                    paymentUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('Payment status updated!', 'success');
                await loadOrders();
                await loadDashboardData();
            } catch (error) {
                console.error('Error updating payment:', error);
                showToast('Error updating payment: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Show order items modal
        async function showOrderItemsModal(orderId) {
            const order = orders.find(o => o.firestoreId === orderId);
            if (!order) {
                showToast('Order not found', 'error');
                return;
            }
            
            currentOrderItems = order.orderItems || order.items || [];
            
            let itemsHtml = '<p>Update individual item status:</p>';
            
            if (currentOrderItems.length === 0) {
                itemsHtml += '<p class="text-muted">No items found in this order</p>';
            } else {
                currentOrderItems.forEach((item, index) => {
                    const itemStatus = item.status || 'pending';
                    const itemName = item.name || item.productName || `Item ${index + 1}`;
                    const itemQuantity = item.quantity || 1;
                    const itemPrice = item.price || 0;
                    
                    itemsHtml += `
                        <div class="order-item-status-control">
                            <div class="item-info">
                                <div class="item-name">${itemQuantity}x ${itemName}</div>
                                <div class="item-price">‚Çπ${itemPrice.toFixed(2)} each</div>
                            </div>
                            <div>
                                <select class="form-select item-status-select" data-index="${index}">
                                    <option value="pending" ${itemStatus === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="preparing" ${itemStatus === 'preparing' ? 'selected' : ''}>Preparing</option>
                                    <option value="packed" ${itemStatus === 'packed' ? 'selected' : ''}>Packed</option>
                                    <option value="ready" ${itemStatus === 'ready' ? 'selected' : ''}>Ready</option>
                                    <option value="delivered" ${itemStatus === 'delivered' ? 'selected' : ''}>Delivered</option>
                                    <option value="cancelled" ${itemStatus === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('orderItemsList').innerHTML = itemsHtml;
            document.getElementById('orderItemsModal').classList.add('active');
        }

        function closeOrderItemsModal() {
            document.getElementById('orderItemsModal').classList.remove('active');
            currentOrderItems = [];
        }

        async function saveOrderItemsStatus() {
            try {
                showLoading(true);
                
                const selects = document.querySelectorAll('.item-status-select');
                let hasChanges = false;
                
                for (let select of selects) {
                    const index = parseInt(select.dataset.index);
                    const newStatus = select.value;
                    
                    if (currentOrderItems[index] && currentOrderItems[index].status !== newStatus) {
                        currentOrderItems[index].status = newStatus;
                        hasChanges = true;
                        
                        if (currentOrderItems[index].id) {
                            await db.collection('orderItems').doc(currentOrderItems[index].id).update({
                                status: newStatus,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                }
                
                if (hasChanges) {
                    showToast('Item statuses updated successfully!', 'success');
                    closeOrderItemsModal();
                    await loadOrders();
                } else {
                    showToast('No changes to save', 'info');
                }
                
            } catch (error) {
                console.error('Error saving item statuses:', error);
                showToast('Error saving item statuses: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // View Order Details - FULL SCREEN
        async function viewOrderDetails(orderId) {
            const order = orders.find(o => o.firestoreId === orderId);
            if (!order) {
                showToast('Order not found', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                const orderDate = order.createdAt ? 
                    (order.createdAt.toDate ? order.createdAt.toDate() : new Date(order.createdAt)).toLocaleString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 
                    'Recently';
                
                const customerName = order.customerName || order.name || order.userName || 
                                   (order.user && order.user.name) || 
                                   (order.customer && order.customer.name) || 
                                   'Customer';
                
                const customerPhone = order.customerPhone || order.phone || 
                                    (order.user && order.user.phone) ||
                                    (order.customer && order.customer.phone) || 
                                    'N/A';
                
                // IMPROVED ADDRESS EXTRACTION FOR ORDER DETAILS
                let customerAddress = 'N/A';

                        if (order.address && typeof order.address === 'object') {
                            const addr = order.address;
                            const parts = [];
                        
                            if (addr.details) parts.push(addr.details);
                            if (addr.landmark) parts.push(addr.landmark);
                            if (addr.city) parts.push(addr.city);
                            if (addr.pincode) parts.push(addr.pincode);
                        
                            if (parts.length > 0) {
                                customerAddress = parts.join(', ');
                            }
                        }

                } else if (order.customerAddress && typeof order.customerAddress === 'string') {
                    customerAddress = order.customerAddress;
                } else if (order.user && order.user.address) {
                    if (typeof order.user.address === 'string') {
                        customerAddress = order.user.address;
                    } else if (typeof order.user.address === 'object') {
                        const addr = order.user.address;
                        const parts = [];
                        if (addr.street) parts.push(addr.street);
                        if (addr.area) parts.push(addr.area);
                        if (addr.city) parts.push(addr.city);
                        if (addr.state) parts.push(addr.state);
                        if (addr.pincode) parts.push(addr.pincode);
                        if (addr.landmark) parts.push(`Landmark: ${addr.landmark}`);
                        if (parts.length > 0) customerAddress = parts.join(', ');
                    }
                } else if (order.customer && order.customer.address) {
                    if (typeof order.customer.address === 'string') {
                        customerAddress = order.customer.address;
                    } else if (typeof order.customer.address === 'object') {
                        const addr = order.customer.address;
                        const parts = [];
                        if (addr.street) parts.push(addr.street);
                        if (addr.area) parts.push(addr.area);
                        if (addr.city) parts.push(addr.city);
                        if (addr.state) parts.push(addr.state);
                        if (addr.pincode) parts.push(addr.pincode);
                        if (addr.landmark) parts.push(`Landmark: ${addr.landmark}`);
                        if (parts.length > 0) customerAddress = parts.join(', ');
                    }
                } else if (order.deliveryAddress && typeof order.deliveryAddress === 'string') {
                    customerAddress = order.deliveryAddress;
                }
                
                const customerEmail = order.customerEmail || order.email || 
                                    (order.user && order.user.email) ||
                                    (order.customer && order.customer.email) ||
                                    'N/A';
                
                let itemsHtml = '';
                const orderItems = order.orderItems || order.items || [];
                
                if (orderItems.length === 0) {
                    itemsHtml = '<p class="text-muted">No items in this order</p>';
                } else {
                    itemsHtml = `
                        <table class="order-items-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    orderItems.forEach((item, index) => {
                        const itemTotal = (item.price || 0) * (item.quantity || 1);
                        const itemStatus = item.status || order.status || 'pending';
                        let statusClass = '';
                        let statusText = '';
                        
                        switch(itemStatus) {
                            case 'pending':
                                statusClass = 'order-item-status pending';
                                statusText = 'Pending';
                                break;
                            case 'confirmed':
                                statusClass = 'order-item-status confirmed';
                                statusText = 'Confirmed';
                                break;
                            case 'preparing':
                                statusClass = 'order-item-status preparing';
                                statusText = 'Preparing';
                                break;
                            case 'packed':
                                statusClass = 'order-item-status packed';
                                statusText = 'Packed';
                                break;
                            case 'ready_for_pickup':
                                statusClass = 'order-item-status ready';
                                statusText = 'Ready for Pickup';
                                break;
                            case 'picked_up':
                                statusClass = 'order-item-status delivered';
                                statusText = 'Picked Up';
                                break;
                            case 'dispatched':
                                statusClass = 'order-item-status dispatched';
                                statusText = 'Dispatched';
                                break;
                            case 'out_for_delivery':
                                statusClass = 'order-item-status out_for_delivery';
                                statusText = 'Out for Delivery';
                                break;
                            case 'delivered':
                                statusClass = 'order-item-status delivered';
                                statusText = 'Delivered';
                                break;
                            case 'cancelled':
                                statusClass = 'order-item-status cancelled';
                                statusText = 'Cancelled';
                                break;
                            case 'rejected':
                                statusClass = 'order-item-status rejected';
                                statusText = 'Rejected';
                                break;
                            default:
                                statusClass = 'order-item-status pending';
                                statusText = itemStatus;
                        }

                        
                        itemsHtml += `
                            <tr>
                                <td>${item.name || 'Product'}</td>
                                <td>${item.quantity || 1}</td>
                                <td>‚Çπ${(item.price || 0).toFixed(2)}</td>
                                <td><span class="${statusClass}">${statusText}</span></td>
                                <td>‚Çπ${itemTotal.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    itemsHtml += '</tbody></table>';
                }
                
                let statusText = '';
                let statusClass = '';
                
                const isPickupOnly = currentShop.deliveryType === 'pickup_only';
                
                switch(order.status) {
                    case 'pending': 
                        statusText = 'Pending'; 
                        statusClass = 'status-text status-pending';
                        break;
                    case 'confirmed': 
                        statusText = order.isPartialOrder ? 'Partially Accepted' : 'Confirmed'; 
                        statusClass = 'status-text status-confirmed';
                        break;
                    case 'preparing': 
                        statusText = order.isPartialOrder ? 'Preparing (Partial)' : 'Preparing'; 
                        statusClass = 'status-text status-preparing';
                        break;
                    case 'packed': 
                        statusText = isPickupOnly ? 'Packed' : 'Preparing';
                        statusClass = 'status-text status-packed';
                        break;
                    case 'ready_for_pickup': 
                        statusText = 'Ready for Pickup'; 
                        statusClass = 'status-text status-ready_for_pickup';
                        break;
                    case 'picked_up': 
                        statusText = 'Picked Up'; 
                        statusClass = 'status-text status-picked_up';
                        break;
                    case 'dispatched': 
                        statusText = order.isPartialOrder ? 'Dispatched (Partial)' : 'Dispatched'; 
                        statusClass = 'status-text status-dispatched';
                        break;
                    case 'out_for_delivery': 
                        statusText = 'Out for Delivery'; 
                        statusClass = 'status-text status-out_for_delivery';
                        break;
                    case 'delivered': 
                        statusText = order.isPartialOrder ? 'Delivered (Partial)' : 'Delivered'; 
                        statusClass = 'status-text status-delivered';
                        break;
                    case 'cancelled': 
                        statusText = 'Cancelled'; 
                        statusClass = 'status-text status-cancelled';
                        break;
                    case 'rejected': 
                        statusText = 'Rejected'; 
                        statusClass = 'status-text status-rejected';
                        break;
                    default: 
                        statusText = order.status || 'Unknown';
                        statusClass = 'status-text';
                }
                
                const paymentMethod = order.paymentMethod || 'cod';
                const paymentStatus = order.paymentStatus || 'pending';
                
                let paymentMethodText = '';
                switch(paymentMethod) {
                    case 'cod': paymentMethodText = 'Cash on Delivery'; break;
                    case 'qr': paymentMethodText = 'QR Code'; break;
                    case 'online': paymentMethodText = 'Online Payment'; break;
                    default: paymentMethodText = paymentMethod;
                }
                
                let paymentStatusText = paymentStatus === 'paid' ? 'Paid' : 'Unpaid';
                let paymentStatusClass = paymentStatus === 'paid' ? 'payment-text payment-paid' : 'payment-text payment-unpaid';
                
                let orderAmount = 0;
                if (order.isPartialOrder) {
                    orderAmount = order.acceptedTotal || order.total || 0;
                } else {
                    orderAmount = order.total || order.totalAmount || 0;
                }
                
                let couponInfoHtml = '';
                if (order.couponCode) {
                    const couponDiscount = order.couponDiscount || 0;
                    const subtotal = order.subtotal || orderAmount + couponDiscount;
                    
                    couponInfoHtml = `
                        <div class="order-info-item">
                            <div class="order-info-label">Coupon Applied:</div>
                            <div class="order-info-value">
                                <span class="badge bg-info">${order.couponCode}</span>
                                <span class="text-success">-‚Çπ${couponDiscount.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="order-info-item">
                            <div class="order-info-label">Subtotal:</div>
                            <div class="order-info-value">‚Çπ${subtotal.toFixed(2)}</div>
                        </div>
                    `;
                }
                
                let partialInfoHtml = '';
                if (order.isPartialOrder) {
                    const acceptedItems = order.acceptedItems || [];
                    const rejectedItems = order.rejectedItems || [];
                    
                    if (acceptedItems.length > 0 || rejectedItems.length > 0) {
                        partialInfoHtml = `
                            <div class="order-section">
                                <h4><i class="fas fa-clipboard-check"></i> Partial Order Details</h4>
                                <div class="order-grid">
                                    <div class="order-info-item">
                                        <div class="order-info-label">Accepted Items:</div>
                                        <div class="order-info-value">${acceptedItems.length} items</div>
                                    </div>
                                    <div class="order-info-item">
                                        <div class="order-info-label">Rejected Items:</div>
                                        <div class="order-info-value">${rejectedItems.length} items</div>
                                    </div>
                                </div>
                                <div class="order-info-item" style="margin-top: 1rem;">
                                    <div class="order-info-label">Accepted Total:</div>
                                    <div class="order-info-value"><strong>‚Çπ${orderAmount.toFixed(2)}</strong></div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                let serviceTypeHtml = '';
                if (currentShop.deliveryType === 'pickup_only') {
                    serviceTypeHtml = `
                        <div class="order-info-item">
                            <div class="order-info-label">Service Type:</div>
                            <div class="order-info-value"><span class="status-text status-ready_for_pickup">Pickup Only</span></div>
                        </div>
                    `;
                } else if (currentShop.deliveryType === 'delivery_only') {
                    serviceTypeHtml = `
                        <div class="order-info-item">
                            <div class="order-info-label">Service Type:</div>
                            <div class="order-info-value"><span class="status-text status-delivered">Delivery Only</span></div>
                        </div>
                    `;
                } else {
                    serviceTypeHtml = `
                        <div class="order-info-item">
                            <div class="order-info-label">Service Type:</div>
                            <div class="order-info-value"><span class="status-text status-confirmed">Both Delivery & Pickup</span></div>
                        </div>
                    `;
                }
                
                let timestampsHtml = '';
                if (order.preparationStartTime || order.packedTime || order.readyForPickupTime || 
                    order.outForDeliveryTime || order.deliveredTime) {
                    
                    timestampsHtml = `
                        <div class="order-section">
                            <h4><i class="fas fa-clock"></i> Order Timeline</h4>
                            <div class="timeline">
                    `;
                    
                    if (order.createdAt) {
                        const createdTime = order.createdAt.toDate ? 
                            order.createdAt.toDate().toLocaleTimeString() : 
                            new Date(order.createdAt).toLocaleTimeString();
                        timestampsHtml += `
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <h6>Order Placed</h6>
                                    <p class="text-muted mb-0">${createdTime}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (order.preparationStartTime) {
                        const prepTime = order.preparationStartTime.toDate ? 
                            order.preparationStartTime.toDate().toLocaleTimeString() : 
                            new Date(order.preparationStartTime).toLocaleTimeString();
                        timestampsHtml += `
                            <div class="timeline-item">
                                <div class="timeline-marker bg-info"></div>
                                <div class="timeline-content">
                                    <h6>Preparation Started</h6>
                                    <p class="text-muted mb-0">${prepTime}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (order.packedTime) {
                        const packedTime = order.packedTime.toDate ? 
                            order.packedTime.toDate().toLocaleTimeString() : 
                            new Date(order.packedTime).toLocaleTimeString();
                        timestampsHtml += `
                            <div class="timeline-item">
                                <div class="timeline-marker bg-warning"></div>
                                <div class="timeline-content">
                                    <h6>Order Packed</h6>
                                    <p class="text-muted mb-0">${packedTime}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (order.readyForPickupTime) {
                        const readyTime = order.readyForPickupTime.toDate ? 
                            order.readyForPickupTime.toDate().toLocaleTimeString() : 
                            new Date(order.readyForPickupTime).toLocaleTimeString();
                        timestampsHtml += `
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                    <h6>Ready for Pickup</h6>
                                    <p class="text-muted mb-0">${readyTime}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (order.outForDeliveryTime) {
                        const deliveryTime = order.outForDeliveryTime.toDate ? 
                            order.outForDeliveryTime.toDate().toLocaleTimeString() : 
                            new Date(order.outForDeliveryTime).toLocaleTimeString();
                        timestampsHtml += `
                            <div class="timeline-item">
                                <div class="timeline-marker bg-warning"></div>
                                <div class="timeline-content">
                                    <h6>Out for Delivery</h6>
                                    <p class="text-muted mb-0">${deliveryTime}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (order.deliveredTime) {
                        const deliveredTime = order.deliveredTime.toDate ? 
                            order.deliveredTime.toDate().toLocaleTimeString() : 
                            new Date(order.deliveredTime).toLocaleTimeString();
                        timestampsHtml += `
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                    <h6>Delivered</h6>
                                    <p class="text-muted mb-0">${deliveredTime}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    timestampsHtml += `
                            </div>
                        </div>
                    `;
                }
                
                const detailsHtml = `
                    <div class="order-details">
                        <!-- Order Information -->
                        <div class="order-section">
                            <h4><i class="fas fa-info-circle"></i> Order Information</h4>
                            <div class="order-grid">
                                <div class="order-info-item">
                                    <div class="order-info-label">Order ID:</div>
                                    <div class="order-info-value">#${order.shortId || generateShortOrderId(order.id)}</div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">Order Date:</div>
                                    <div class="order-info-value">${orderDate}</div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">Status:</div>
                                    <div class="order-info-value">
                                        <span class="${statusClass}">${statusText}</span>
                                    </div>
                                </div>
                                ${serviceTypeHtml}
                                ${couponInfoHtml}
                                <div class="order-info-item">
                                    <div class="order-info-label">Payment Method:</div>
                                    <div class="order-info-value">${paymentMethodText}</div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">Payment Status:</div>
                                    <div class="order-info-value">
                                        <span class="${paymentStatusClass}">${paymentStatusText}</span>
                                    </div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">Total Amount:</div>
                                    <div class="order-info-value"><strong>‚Çπ${orderAmount.toFixed(2)}</strong></div>
                                </div>
                            </div>
                        </div>
                        
                        ${timestampsHtml}
                        
                        <!-- Customer Information - WITH IMPROVED ADDRESS -->
                        <div class="order-section">
                            <h4><i class="fas fa-user"></i> Customer Information</h4>
                            <div class="order-grid">
                                <div class="order-info-item">
                                    <div class="order-info-label">Name:</div>
                                    <div class="order-info-value"><strong>${customerName}</strong></div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">Phone:</div>
                                    <div class="order-info-value">${customerPhone}</div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">Email:</div>
                                    <div class="order-info-value">${customerEmail}</div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">Address:</div>
                                    <div class="order-info-value" style="white-space: pre-wrap;">${customerAddress}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${partialInfoHtml}
                        
                        <!-- Order Items -->
                        <div class="order-section">
                            <h4><i class="fas fa-shopping-cart"></i> Order Items</h4>
                            ${itemsHtml}
                            <div class="order-total">
                                ${order.couponCode ? `
                                    <div style="margin-bottom: 0.5rem;">
                                        <span style="color: #666;">Subtotal: ‚Çπ${(order.subtotal || orderAmount + (order.couponDiscount || 0)).toFixed(2)}</span>
                                        <div style="color: #27ae60;">Coupon Discount: -‚Çπ${(order.couponDiscount || 0).toFixed(2)}</div>
                                    </div>
                                ` : ''}
                                <div class="total-amount">Total: ‚Çπ${orderAmount.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        ${order.notes ? `
                            <div class="order-section">
                                <h4><i class="fas fa-sticky-note"></i> Order Notes</h4>
                                <div class="order-info-item">
                                    <div class="order-info-value">${order.notes}</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${order.refundStatus && order.refundStatus !== 'none' ? `
                            <div class="order-section">
                                <h4><i class="fas fa-exchange-alt"></i> Refund Information</h4>
                                <div class="order-grid">
                                    <div class="order-info-item">
                                        <div class="order-info-label">Refund Status:</div>
                                        <div class="order-info-value">
                                            <span class="${getRefundStatusClass(order.refundStatus)}">
                                                ${order.refundStatus === 'pending' ? 'Pending' : 
                                                  order.refundStatus === 'completed' ? 'Completed' : 
                                                  order.refundStatus === 'rejected' ? 'Rejected' : order.refundStatus}
                                            </span>
                                        </div>
                                    </div>
                                    ${order.refundAmount ? `
                                        <div class="order-info-item">
                                            <div class="order-info-label">Refund Amount:</div>
                                            <div class="order-info-value">‚Çπ${order.refundAmount.toFixed(2)}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Action Buttons -->
                        <div class="order-section">
                            <h4><i class="fas fa-cogs"></i> Actions</h4>
                            <div class="action-buttons">
                                ${order.status === 'pending' ? `
                                    <button class="action-btn btn-success" onclick="updateOrderStatus('${order.firestoreId}', 'confirmed')">
                                        <i class="fas fa-check"></i> Accept All
                                    </button>
                                    <button class="action-btn btn-warning" onclick="showPartialOrderModal('${order.firestoreId}')">
                                        <i class="fas fa-check-double"></i> Accept Partial
                                    </button>
                                    <button class="action-btn btn-danger" onclick="updateOrderStatus('${order.firestoreId}', 'rejected')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'confirmed' ? `
                                    <button class="action-btn btn-info" onclick="updateOrderStatus('${order.firestoreId}', 'preparing')">
                                        <i class="fas fa-utensils"></i> Start Preparing
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'preparing' && currentShop.deliveryType === 'pickup_only' ? `
                                    <button class="action-btn btn-warning" onclick="updateOrderStatus('${order.firestoreId}', 'packed')">
                                        <i class="fas fa-box"></i> Mark as Packed
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'preparing' && currentShop.deliveryType !== 'pickup_only' ? `
                                    <button class="action-btn btn-warning" onclick="updateOrderStatus('${order.firestoreId}', 'dispatched')">
                                        <i class="fas fa-shipping-fast"></i> Mark as Dispatched
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'packed' ? `
                                    <button class="action-btn btn-success" onclick="updateOrderStatus('${order.firestoreId}', 'ready_for_pickup')">
                                        <i class="fas fa-check-circle"></i> Ready for Pickup
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'ready_for_pickup' ? `
                                    <button class="action-btn btn-success" onclick="updateOrderStatus('${order.firestoreId}', 'picked_up')">
                                        <i class="fas fa-check-circle"></i> Mark as Picked Up
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'dispatched' ? `
                                    <button class="action-btn btn-success" onclick="updateOrderStatus('${order.firestoreId}', 'out_for_delivery')">
                                        <i class="fas fa-truck"></i> Out for Delivery
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'out_for_delivery' ? `
                                    <button class="action-btn btn-success" onclick="updateOrderStatus('${order.firestoreId}', 'delivered')">
                                        <i class="fas fa-check-circle"></i> Mark as Delivered
                                    </button>
                                ` : ''}
                                
                                ${(order.status === 'delivered' || order.status === 'picked_up') && paymentStatus === 'pending' ? `
                                    <button class="action-btn btn-success" onclick="markAsPaid('${order.firestoreId}', ${orderAmount})">
                                        <i class="fas fa-money-bill-wave"></i> Mark as Paid
                                    </button>
                                ` : ''}
                                
                                ${(order.status === 'delivered' || order.status === 'picked_up') && (!order.refundStatus || order.refundStatus === 'none') ? `
                                    <button class="action-btn btn-warning" onclick="showInitiateRefundModal('${order.firestoreId}')">
                                        <i class="fas fa-exchange-alt"></i> Initiate Refund
                                    </button>
                                ` : ''}
                                
                                ${(order.status === 'preparing' || order.status === 'packed') ? `
                                    <button class="action-btn btn-info" onclick="showOrderItemsModal('${order.firestoreId}')">
                                        <i class="fas fa-clipboard-list"></i> Manage Items Status
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('orderDetailsContent').innerHTML = detailsHtml;
                document.getElementById('orderDetailsModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading order details:', error);
                showToast('Error loading order details: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function closeOrderDetailsModal() {
            document.getElementById('orderDetailsModal').classList.remove('active');
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pending': return 'status-text status-pending';
                case 'confirmed': return 'status-text status-confirmed';
                case 'preparing': return 'status-text status-preparing';
                case 'packed': return 'status-text status-packed';
                case 'ready_for_pickup': return 'status-text status-ready_for_pickup';
                case 'picked_up': return 'status-text status-picked_up';
                case 'dispatched': return 'status-text status-dispatched';
                case 'out_for_delivery': return 'status-text status-out_for_delivery';
                case 'delivered': return 'status-text status-delivered';
                case 'cancelled': return 'status-text status-cancelled';
                case 'rejected': return 'status-text status-rejected';
                default: return 'status-text';
            }
        }

        // ==================== REFUND MANAGEMENT ====================
        
        // Load refunds function
        async function loadRefunds() {
            if (!currentShop) return;
            
            try {
                showLoading(true);
                
                refunds = [];
                
                try {
                    const refundsSnapshot = await db.collection('refunds')
                        .where('shopId', '==', currentShop.id)
                        .orderBy('initiatedAt', 'desc')
                        .get();
                    
                    refundsSnapshot.forEach(doc => {
                        const refundData = doc.data();
                        refunds.push({ 
                            id: doc.id, 
                            ...refundData,
                            shortId: 'REF-' + (refundData.refundId ? 
                                refundData.refundId.substring(refundData.refundId.length - 6) : 
                                doc.id.substring(doc.id.length - 6)).toUpperCase()
                        });
                    });
                } catch (error) {
                    console.error('Error querying refunds:', error);
                    
                    try {
                        const refundsSnapshot = await db.collection('refunds')
                            .where('shopId', '==', currentShop.id)
                            .get();
                        
                        refundsSnapshot.forEach(doc => {
                            const refundData = doc.data();
                            refunds.push({ 
                                id: doc.id, 
                                ...refundData,
                                shortId: 'REF-' + (refundData.refundId ? 
                                    refundData.refundId.substring(refundData.refundId.length - 6) : 
                                    doc.id.substring(doc.id.length - 6)).toUpperCase()
                            });
                        });
                        
                        refunds.sort((a, b) => {
                            const dateA = a.initiatedAt ? (a.initiatedAt.toDate ? a.initiatedAt.toDate() : new Date(a.initiatedAt)) : new Date(0);
                            const dateB = b.initiatedAt ? (b.initiatedAt.toDate ? b.initiatedAt.toDate() : new Date(b.initiatedAt)) : new Date(0);
                            return dateB - dateA;
                        });
                        
                    } catch (secondError) {
                        console.error('Alternative query also failed:', secondError);
                    }
                }
                
                filterRefunds();
                updateRefundStats();
                await updateOrdersWithRefundInfo();
                
            } catch (error) {
                console.error("Error loading refunds:", error);
                showToast('Error loading refunds: ' + error.message, 'error');
                refunds = [];
                filteredRefunds = [];
                renderRefunds();
            } finally {
                showLoading(false);
            }
        }

        // Update orders with refund info
        async function updateOrdersWithRefundInfo() {
            for (let i = 0; i < orders.length; i++) {
                const order = orders[i];
                
                const orderRefunds = refunds.filter(r => 
                    r.orderId === order.id || 
                    r.orderId === order.orderId ||
                    (order.orderId && r.orderId === order.orderId)
                );
                
                if (orderRefunds.length > 0) {
                    const latestRefund = orderRefunds[0];
                    orders[i].refundStatus = latestRefund.status;
                    orders[i].refundAmount = latestRefund.amount;
                    orders[i].refundId = latestRefund.id;
                } else {
                    orders[i].refundStatus = 'none';
                }
            }
            
            renderOrders();
        }

        function filterRefunds() {
            const filterValue = document.getElementById('refundStatusFilter').value;
            
            if (filterValue === 'all') {
                filteredRefunds = [...refunds];
            } else {
                filteredRefunds = refunds.filter(refund => refund.status === filterValue);
            }
            
            renderRefunds();
        }

        function updateRefundStats() {
            const pendingCount = refunds.filter(r => r.status === 'pending').length;
            const completedCount = refunds.filter(r => r.status === 'completed').length;
            const rejectedCount = refunds.filter(r => r.status === 'rejected').length;
            const totalAmount = refunds.filter(r => r.status === 'completed')
                .reduce((sum, refund) => sum + (refund.amount || 0), 0);
            
            document.getElementById('refundStatsPending').textContent = pendingCount;
            document.getElementById('refundStatsCompleted').textContent = completedCount;
            document.getElementById('refundStatsRejected').textContent = rejectedCount;
            document.getElementById('refundStatsAmount').textContent = `‚Çπ${totalAmount.toFixed(2)}`;
        }

        function renderRefunds() {
            const refundsList = document.getElementById('refundsList');
            
            if (filteredRefunds.length === 0) {
                refundsList.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem;">
                            <i class="fas fa-exchange-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                            <h4 style="color: #666;">No Refunds Found</h4>
                            <p style="color: #999;">No refunds match the current filter</p>
                            <button class="btn btn-primary mt-2" onclick="navigateToPage('orders')">
                                <i class="fas fa-shopping-bag"></i> Go to Orders
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let refundsHtml = '';
            
            filteredRefunds.forEach((refund) => {
                try {
                    const initiatedDate = refund.initiatedAt ? 
                        (refund.initiatedAt.toDate ? 
                            refund.initiatedAt.toDate().toLocaleDateString('en-IN', {
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : 
                            new Date(refund.initiatedAt).toLocaleDateString('en-IN', {
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })) : 
                        'N/A';
                    
                    let statusText = '';
                    let statusClass = '';
                    
                    switch(refund.status) {
                        case 'pending':
                            statusText = 'Pending';
                            statusClass = 'status-text status-refund_pending';
                            break;
                        case 'completed':
                            statusText = 'Completed';
                            statusClass = 'status-text status-refund_completed';
                            break;
                        case 'rejected':
                            statusText = 'Rejected';
                            statusClass = 'status-text status-refund_rejected';
                            break;
                        default:
                            statusText = refund.status || 'Unknown';
                            statusClass = 'status-text';
                    }
                    
                    let actionButtons = '';
                    
                    if (refund.status === 'pending') {
                        actionButtons = `
                            <div class="action-buttons">
                                <button class="action-btn btn-success" onclick="updateRefundStatus('${refund.id}', 'completed')">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                                <button class="action-btn btn-danger" onclick="updateRefundStatus('${refund.id}', 'rejected')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        `;
                    } else {
                        actionButtons = `
                            <span class="text-muted">No actions available</span>
                        `;
                    }
                    
                    actionButtons += `
                        <button class="action-btn btn-info mt-1" onclick="viewRefundDetails('${refund.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    `;
                    
                    refundsHtml += `
                        <tr>
                            <td><strong>${refund.shortId || 'REF-' + refund.id.substring(refund.id.length - 6).toUpperCase()}</strong></td>
                            <td>${refund.orderId}</td>
                            <td>${refund.customerName}</td>
                            <td><strong>‚Çπ${(refund.amount || 0).toFixed(2)}</strong></td>
                            <td>${refund.reason || 'No reason specified'}</td>
                            <td>
                                <span class="${statusClass}">${statusText}</span>
                            </td>
                            <td>${initiatedDate}</td>
                            <td>${actionButtons}</td>
                        </tr>
                    `;
                    
                } catch (error) {
                    console.error('Error rendering refund:', refund, error);
                }
            });
            
            refundsList.innerHTML = refundsHtml;
        }

        // Show initiate refund modal - FIXED TO SHOW ONLY UNFULFILLED ITEMS
        function showInitiateRefundModal(orderId) {
            const order = orders.find(o => o.firestoreId === orderId);
            if (!order) {
                showToast('Order not found', 'error');
                return;
            }
            
            currentRefundOrder = order;
            
            document.getElementById('refundOrderId').value = order.id;
            document.getElementById('refundCustomerId').value = order.customerId || '';
            document.getElementById('displayOrderId').value = order.id;
            
            const customerName = order.customerName || order.name || order.userName || 
                               (order.user && order.user.name) || 
                               (order.customer && order.customer.name) || 
                               'Customer';
            document.getElementById('refundCustomerName').value = customerName;
            
            const itemsList = document.getElementById('refundItemsList');
            let itemsHtml = '';
            
            const orderItems = order.orderItems || order.items || [];
            
            if (orderItems.length === 0) {
                itemsHtml = '<p class="text-muted">No items in this order</p>';
            } else {
                itemsHtml = '<p>Select items to refund (only unfulfilled items shown):</p>';
                
                // For partial orders, automatically select rejected items
                const rejectedItems = order.rejectedItems || [];
                const acceptedItems = order.acceptedItems || [];
                
                // Filter items to show only unfulfilled items
                const unfulfilledItems = [];
                
                orderItems.forEach((item, index) => {
                    let isAcceptedItem = false;
                    let acceptedQuantity = 0;
                    
                    if (order.isPartialOrder && acceptedItems.length > 0) {
                        const acceptedItem = acceptedItems.find(ai => 
                            ai.name === item.name || 
                            ai.productId === item.productId ||
                            ai.id === item.id
                        );
                        if (acceptedItem) {
                            isAcceptedItem = true;
                            acceptedQuantity = acceptedItem.quantity || 0;
                        }
                    }
                    
                    // If it's not an accepted item, or if quantity delivered is less than ordered
                    if (!isAcceptedItem || acceptedQuantity < (item.quantity || 1)) {
                        unfulfilledItems.push({
                            ...item,
                            index: index,
                            maxQuantity: isAcceptedItem ? 
                                ((item.quantity || 1) - acceptedQuantity) : 
                                (item.quantity || 1)
                        });
                    }
                });
                
                if (unfulfilledItems.length === 0) {
                    itemsHtml = '<p class="text-success"><i class="fas fa-check-circle"></i> All items were fulfilled. No refundable items found.</p>';
                } else {
                    unfulfilledItems.forEach((item) => {
                        const itemTotal = (item.price || 0) * item.maxQuantity;
                        const index = item.index;
                        
                        itemsHtml += `
                            <div class="refund-item-control">
                                <div class="item-info">
                                    <input type="checkbox" class="refund-checkbox" id="item_${index}" 
                                           data-price="${item.price || 0}" data-quantity="${item.maxQuantity}"
                                           checked
                                           onchange="calculateRefundAmount()">
                                    <label for="item_${index}">
                                        <div class="item-name">${item.name || 'Product'} <span class="badge bg-warning">Unfulfilled</span></div>
                                        <div class="item-price">‚Çπ${(item.price || 0).toFixed(2)} √ó ${item.maxQuantity} = ‚Çπ${itemTotal.toFixed(2)}</div>
                                        ${order.isPartialOrder ? `
                                            <small class="text-muted">
                                                Ordered: ${item.quantity || 1}, Fulfilled: ${(item.quantity || 1) - item.maxQuantity}
                                            </small>
                                        ` : ''}
                                    </label>
                                </div>
                                <div>
                                    <input type="number" class="refund-quantity" id="quantity_${index}" 
                                           min="0" max="${item.maxQuantity}" value="${item.maxQuantity}"
                                           onchange="calculateRefundAmount()">
                                </div>
                            </div>
                        `;
                    });
                }
            }
            
            itemsList.innerHTML = itemsHtml;
            
            // Calculate max refund amount based on unfulfilled items
            let maxAmount = 0;
            
            if (order.isPartialOrder) {
                // For partial orders, max amount is rejected items total
                const rejectedItems = order.rejectedItems || [];
                maxAmount = rejectedItems.reduce((sum, item) => {
                    return sum + ((item.price || 0) * (item.quantity || 1));
                }, 0);
                
                // Also add difference for partially fulfilled items
                const acceptedItems = order.acceptedItems || [];
                orderItems.forEach(item => {
                    const acceptedItem = acceptedItems.find(ai => 
                        ai.name === item.name || 
                        ai.productId === item.productId ||
                        ai.id === item.id
                    );
                    if (acceptedItem) {
                        const orderedQuantity = item.quantity || 1;
                        const acceptedQuantity = acceptedItem.quantity || 0;
                        if (acceptedQuantity < orderedQuantity) {
                            maxAmount += (item.price || 0) * (orderedQuantity - acceptedQuantity);
                        }
                    }
                });
            } else {
                // For full orders, check if all items were delivered
                const isFullyDelivered = order.status === 'delivered' || order.status === 'picked_up';
                if (!isFullyDelivered) {
                    // If not delivered, refund entire amount
                    maxAmount = order.total || order.totalAmount || 0;
                } else {
                    // If delivered, only refund unfulfilled items
                    maxAmount = orderItems.reduce((sum, item) => {
                        const itemStatus = item.status || 'delivered';
                        if (itemStatus !== 'delivered') {
                            return sum + ((item.price || 0) * (item.quantity || 1));
                        }
                        return sum;
                    }, 0);
                }
            }
            
            document.getElementById('maxRefundAmount').textContent = maxAmount.toFixed(2);
            
            calculateRefundAmount();
            
            document.getElementById('initiateRefundModal').classList.add('active');
        }

        function closeInitiateRefundModal() {
            document.getElementById('initiateRefundModal').classList.remove('active');
            currentRefundOrder = null;
            document.getElementById('refundForm').reset();
        }

        function calculateRefundAmount() {
            let total = 0;
            const checkboxes = document.querySelectorAll('.refund-checkbox');
            
            checkboxes.forEach((checkbox, index) => {
                if (checkbox.checked) {
                    const quantityInput = document.getElementById(`quantity_${index}`);
                    const price = parseFloat(checkbox.dataset.price) || 0;
                    const quantity = parseInt(quantityInput.value) || 0;
                    total += price * quantity;
                    
                    quantityInput.disabled = false;
                } else {
                    const quantityInput = document.getElementById(`quantity_${index}`);
                    quantityInput.disabled = true;
                }
            });
            
            document.getElementById('refundAmount').value = total.toFixed(2);
        }

        async function submitRefund() {
            const orderId = document.getElementById('refundOrderId').value;
            const customerId = document.getElementById('refundCustomerId').value;
            const amount = parseFloat(document.getElementById('refundAmount').value);
            const reason = document.getElementById('refundReason').value;
            const notes = document.getElementById('refundNotes').value;
            
            if (!orderId) {
                showToast('Order ID is required', 'error');
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                showToast('Please enter a valid refund amount', 'error');
                return;
            }
            
            if (!reason) {
                showToast('Please select a refund reason', 'error');
                return;
            }
            
            const maxAmount = parseFloat(document.getElementById('maxRefundAmount').textContent);
            if (amount > maxAmount) {
                showToast(`Refund amount cannot exceed ‚Çπ${maxAmount.toFixed(2)}`, 'error');
                return;
            }
            
            const refundItems = [];
            const checkboxes = document.querySelectorAll('.refund-checkbox:checked');
            
            checkboxes.forEach((checkbox, index) => {
                const quantityInput = document.getElementById(`quantity_${index}`);
                if (quantityInput && !quantityInput.disabled) {
                    const quantity = parseInt(quantityInput.value) || 0;
                    if (quantity > 0) {
                        refundItems.push({
                            price: parseFloat(checkbox.dataset.price) || 0,
                            quantity: quantity,
                            maxQuantity: parseInt(checkbox.dataset.quantity) || 0
                        });
                    }
                }
            });
            
            if (!confirm(`Initiate refund of ‚Çπ${amount.toFixed(2)} for order ${orderId}?`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 8).toUpperCase();
                const refundId = `REF_${timestamp}_${random}`;
                
                const customerName = currentRefundOrder?.customerName || 
                                   currentRefundOrder?.name || 
                                   currentRefundOrder?.userName || 
                                   (currentRefundOrder?.user && currentRefundOrder.user.name) || 
                                   (currentRefundOrder?.customer && currentRefundOrder.customer.name) || 
                                   'Customer';
                
                const refundData = {
                    refundId: refundId,
                    orderId: orderId,
                    shopId: currentShop.id,
                    shopName: currentShop.name,
                    customerId: customerId,
                    customerName: customerName,
                    amount: amount,
                    reason: reason,
                    notes: notes,
                    items: refundItems,
                    status: 'pending',
                    paymentMethod: currentRefundOrder?.paymentMethod || 'cod',
                    initiatedBy: currentShop.id,
                    initiatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    estimatedCompletion: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('refunds').add(refundData);
                
                if (currentRefundOrder && currentRefundOrder.firestoreId) {
                    await db.collection('orders').doc(currentRefundOrder.firestoreId).update({
                        refundStatus: 'pending',
                        refundAmount: amount,
                        refundInitiatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showToast('Refund initiated successfully!', 'success');
                closeInitiateRefundModal();
                
                await loadRefunds();
                await loadOrders();
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error initiating refund:', error);
                showToast('Error initiating refund: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Update refund status function
        async function updateRefundStatus(refundId, newStatus) {
            if (!confirm(`Are you sure you want to ${newStatus} this refund?`)) return;
            
            try {
                showLoading(true);
                
                const updateData = {
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (newStatus === 'completed') {
                    updateData.completedAt = firebase.firestore.FieldValue.serverTimestamp();
                    updateData.completedBy = currentShop.id;
                } else if (newStatus === 'rejected') {
                    updateData.rejectedAt = firebase.firestore.FieldValue.serverTimestamp();
                    updateData.rejectedBy = currentShop.id;
                    const rejectionReason = prompt('Enter rejection reason:', '');
                    if (rejectionReason) {
                        updateData.rejectionReason = rejectionReason;
                    }
                }
                
                await db.collection('refunds').doc(refundId).update(updateData);
                
                const refundDoc = await db.collection('refunds').doc(refundId).get();
                if (!refundDoc.exists) {
                    throw new Error('Refund document not found');
                }
                
                const refundData = refundDoc.data();
                const orderId = refundData.orderId;
                const refundAmount = refundData.amount || 0;
                
                let orderQuery = await db.collection('orders').where('orderId', '==', orderId).get();
                
                if (orderQuery.empty) {
                    const orderDoc = await db.collection('orders').doc(orderId).get();
                    if (orderDoc.exists) {
                        await orderDoc.ref.update({
                            refundStatus: newStatus,
                            refundAmount: refundAmount,
                            refundUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        const allOrders = await db.collection('orders')
                            .where('shopId', '==', currentShop.id)
                            .get();
                        
                        let foundOrder = null;
                        allOrders.forEach(doc => {
                            const data = doc.data();
                            if (data.orderId === orderId || doc.id === orderId) {
                                foundOrder = { id: doc.id, ref: doc.ref, data: data };
                            }
                        });
                        
                        if (foundOrder) {
                            await foundOrder.ref.update({
                                refundStatus: newStatus,
                                refundAmount: refundAmount,
                                refundUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                } else {
                    const orderDoc = orderQuery.docs[0];
                    await orderDoc.ref.update({
                        refundStatus: newStatus,
                        refundAmount: refundAmount,
                        refundUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showToast(`Refund ${newStatus === 'completed' ? 'completed successfully!' : 'rejected!'}`, 'success');
                
                await loadRefunds();
                await loadOrders();
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error updating refund:', error);
                showToast('Error updating refund: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function viewRefundDetails(refundId) {
            try {
                showLoading(true);
                
                const refundDoc = await db.collection('refunds').doc(refundId).get();
                if (!refundDoc.exists) {
                    showToast('Refund not found', 'error');
                    return;
                }
                
                const refund = { id: refundDoc.id, ...refundDoc.data() };
                
                let detailsHtml = `
                    <div class="refund-details">
                        <h4>Refund Details</h4>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr>
                                        <th>Refund ID:</th>
                                        <td>${refund.refundId || 'REF-' + refund.id.substring(refund.id.length - 6).toUpperCase()}</td>
                                    </tr>
                                    <tr>
                                        <th>Order ID:</th>
                                        <td>${refund.orderId}</td>
                                    </tr>
                                    <tr>
                                        <th>Customer:</th>
                                        <td>${refund.customerName}</td>
                                    </tr>
                                    <tr>
                                        <th>Shop:</th>
                                        <td>${refund.shopName}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr>
                                        <th>Amount:</th>
                                        <td><strong>‚Çπ${(refund.amount || 0).toFixed(2)}</strong></td>
                                    </tr>
                                    <tr>
                                        <th>Status:</th>
                                        <td>
                                            <span class="${getRefundStatusClass(refund.status)}">
                                                ${refund.status.charAt(0).toUpperCase() + refund.status.slice(1)}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Reason:</th>
                                        <td>${refund.reason}</td>
                                    </tr>
                                    <tr>
                                        <th>Payment Method:</th>
                                        <td>${refund.paymentMethod || 'COD'}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <h5>Timeline</h5>
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <h6>Refund Initiated</h6>
                                    <p class="text-muted mb-0">
                                        ${refund.initiatedAt ? 
                                            (refund.initiatedAt.toDate ? 
                                                refund.initiatedAt.toDate().toLocaleString() : 
                                                new Date(refund.initiatedAt).toLocaleString()) : 
                                            'N/A'}
                                    </p>
                                </div>
                            </div>
                `;
                
                if (refund.completedAt) {
                    detailsHtml += `
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6>Refund Completed</h6>
                                <p class="text-muted mb-0">
                                    ${refund.completedAt.toDate ? 
                                        refund.completedAt.toDate().toLocaleString() : 
                                        new Date(refund.completedAt).toLocaleString()}
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                if (refund.rejectedAt) {
                    detailsHtml += `
                        <div class="timeline-item">
                            <div class="timeline-marker bg-danger"></div>
                            <div class="timeline-content">
                                <h6>Refund Rejected</h6>
                                <p class="text-muted mb-0">
                                    ${refund.rejectedAt.toDate ? 
                                        refund.rejectedAt.toDate().toLocaleString() : 
                                        new Date(refund.rejectedAt).toLocaleString()}
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                detailsHtml += `
                        </div>
                        
                        <h5 class="mt-4">Refund Notes</h5>
                        <div class="card">
                            <div class="card-body">
                                ${refund.notes || 'No additional notes provided.'}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('refundDetailsContent').innerHTML = detailsHtml;
                document.getElementById('refundDetailsModal').classList.add('active');
                
            } catch (error) {
                console.error('Error viewing refund details:', error);
                showToast('Error loading refund details: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function closeRefundDetailsModal() {
            document.getElementById('refundDetailsModal').classList.remove('active');
        }

        function getRefundStatusClass(status) {
            switch(status) {
                case 'pending':
                    return 'status-text status-refund_pending';
                case 'completed':
                    return 'status-text status-refund_completed';
                case 'rejected':
                    return 'status-text status-refund_rejected';
                default:
                    return 'status-text';
            }
        }

        // ==================== PARTIAL ORDER FUNCTIONS ====================
        
        function showPartialOrderModal(orderId) {
            const order = orders.find(o => o.firestoreId === orderId);
            if (!order) {
                showToast('Order not found', 'error');
                return;
            }
            
            currentPartialOrderId = orderId;
            partialOrderItems = JSON.parse(JSON.stringify(order.items || []));
            
            const itemsContainer = document.getElementById('partialOrderItems');
            let itemsHtml = '<p>Adjust quantities of items you can fulfill:</p>';
            
            if (partialOrderItems.length === 0) {
                itemsHtml += '<p>No items found in this order</p>';
            } else {
                partialOrderItems.forEach((item, index) => {
                    const maxQuantity = item.quantity || 1;
                    itemsHtml += `
                        <div class="item-quantity-control">
                            <div class="item-info">
                                <div class="item-name">${item.name || 'Product'}</div>
                                <div class="item-price">‚Çπ${(item.price || 0).toFixed(2)} each</div>
                            </div>
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="changePartialQuantity(${index}, -1)" ${item.selectedQuantity <= 1 ? 'disabled' : ''}>-</button>
                                <span class="quantity-display">${item.selectedQuantity || maxQuantity}</span>
                                <button class="quantity-btn" onclick="changePartialQuantity(${index}, 1)" ${(item.selectedQuantity || maxQuantity) >= maxQuantity ? 'disabled' : ''}>+</button>
                            </div>
                        </div>
                        <div class="max-quantity">Max available: ${maxQuantity}</div>
                    `;
                    
                    if (!item.selectedQuantity) {
                        item.selectedQuantity = maxQuantity;
                    }
                });
            }
            
            itemsContainer.innerHTML = itemsHtml;
            updatePartialOrderTotal();
            
            document.getElementById('partialOrderModal').classList.add('active');
        }

        function changePartialQuantity(index, change) {
            if (!partialOrderItems[index]) return;
            
            const maxQuantity = partialOrderItems[index].quantity || 1;
            let newQuantity = (partialOrderItems[index].selectedQuantity || maxQuantity) + change;
            
            newQuantity = Math.max(0, Math.min(newQuantity, maxQuantity));
            
            partialOrderItems[index].selectedQuantity = newQuantity;
            
            const quantityDisplay = document.querySelectorAll('.quantity-display')[index];
            if (quantityDisplay) {
                quantityDisplay.textContent = newQuantity;
            }
            
            const minusBtn = document.querySelectorAll('.quantity-btn')[index * 2];
            const plusBtn = document.querySelectorAll('.quantity-btn')[index * 2 + 1];
            
            if (minusBtn) minusBtn.disabled = newQuantity <= 1;
            if (plusBtn) plusBtn.disabled = newQuantity >= maxQuantity;
            
            updatePartialOrderTotal();
        }

        function updatePartialOrderTotal() {
            let total = 0;
            partialOrderItems.forEach(item => {
                const quantity = item.selectedQuantity || item.quantity || 0;
                const price = item.price || 0;
                total += quantity * price;
            });
            
            document.getElementById('partialOrderTotalAmount').textContent = total.toFixed(2);
        }

        function closePartialOrderModal() {
            document.getElementById('partialOrderModal').classList.remove('active');
            currentPartialOrderId = null;
            partialOrderItems = [];
        }

        async function confirmPartialOrder() {
            if (!currentPartialOrderId) return;
            
            const acceptedItems = [];
            const rejectedItems = [];
            let acceptedTotal = 0;
            
            partialOrderItems.forEach(item => {
                const originalQuantity = item.quantity || 1;
                const acceptedQuantity = item.selectedQuantity || 0;
                
                if (acceptedQuantity > 0) {
                    const acceptedItem = { ...item };
                    acceptedItem.quantity = acceptedQuantity;
                    acceptedItem.totalPrice = acceptedQuantity * (item.price || 0);
                    acceptedItems.push(acceptedItem);
                    acceptedTotal += acceptedItem.totalPrice;
                }
                
                if (acceptedQuantity < originalQuantity) {
                    const rejectedItem = { ...item };
                    rejectedItem.quantity = originalQuantity - acceptedQuantity;
                    rejectedItem.totalPrice = rejectedItem.quantity * (item.price || 0);
                    rejectedItems.push(rejectedItem);
                }
            });
            
            if (acceptedItems.length === 0) {
                showToast('Please accept at least one item', 'error');
                return;
            }
            
            if (!confirm(`Confirm partial order?\n\nAccepted: ${acceptedItems.length} items (‚Çπ${acceptedTotal.toFixed(2)})\nRejected: ${rejectedItems.length} items`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                const updateData = {
                    status: 'confirmed',
                    isPartialOrder: true,
                    acceptedItems: acceptedItems,
                    rejectedItems: rejectedItems,
                    acceptedTotal: acceptedTotal,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('orders').doc(currentPartialOrderId).update(updateData);
                
                closePartialOrderModal();
                showToast('Partial order accepted!', 'success');
                await loadOrders();
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error confirming partial order:', error);
                showToast('Error confirming partial order: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== PROFILE MANAGEMENT FUNCTIONS ====================
        
        // Update profile form with current shop data
        function updateProfileForm() {
            if (!currentShop) return;
            
            document.getElementById('shopName').value = currentShop.name || '';
            document.getElementById('shopCategory').value = currentShop.category || 'groceries';
            document.getElementById('shopDescription').value = currentShop.description || '';
            document.getElementById('shopAddress').value = currentShop.address || '';
            document.getElementById('shopPhone').value = currentShop.phone || '';
            document.getElementById('shopOpenTime').value = currentShop.openTime || '09:00';
            document.getElementById('shopCloseTime').value = currentShop.closeTime || '21:00';
            document.getElementById('shopStatus').value = currentShop.status || 'open';
            document.getElementById('deliveryType').value = currentShop.deliveryType || 'both';
            
            const serviceOptions = document.querySelectorAll('.service-option');
            serviceOptions.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-value') === (currentShop.deliveryType || 'both')) {
                    option.classList.add('active');
                }
            });
        }

        // Handle profile form submission
        async function handleProfileUpdate(event) {
            event.preventDefault();
            
            const shopCategory = document.getElementById('shopCategory').value;
            let finalCategory = shopCategory;
            
            if (shopCategory === 'other') {
                const newCategoryName = document.getElementById('newCategoryName').value.trim();
                if (!newCategoryName) {
                    showToast('Please enter new category name', 'error');
                    return;
                }
                
                const success = await addNewCategory(newCategoryName);
                if (success) {
                    finalCategory = newCategoryName.toLowerCase().replace(/\s+/g, '_');
                } else {
                    finalCategory = 'other';
                }
            }
            
            const profileData = {
                name: document.getElementById('shopName').value.trim(),
                category: finalCategory,
                description: document.getElementById('shopDescription').value.trim(),
                address: document.getElementById('shopAddress').value.trim(),
                phone: document.getElementById('shopPhone').value.trim(),
                openTime: document.getElementById('shopOpenTime').value,
                closeTime: document.getElementById('shopCloseTime').value,
                status: document.getElementById('shopStatus').value,
                deliveryType: document.getElementById('deliveryType').value,
                availableCategories: shopCategories,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!profileData.name || !profileData.address || !profileData.phone) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            try {
                showLoading(true);
                await db.collection('shops').doc(currentShop.id).update(profileData);
                currentShop = { ...currentShop, ...profileData };
                
                // Show success message
                showSettingsSavedMessage('‚úÖ Profile updated successfully!');
                    
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Error updating profile: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Service type selection
        function setupServiceOptions() {
            const serviceOptions = document.querySelectorAll('.service-option');
            serviceOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    document.getElementById('deliveryType').value = value;
                    
                    serviceOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // Utility Functions
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<div class="toast-message">${message}</div>`;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Profile form
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            
            // Settings forms - FIXED EVENT LISTENERS
            document.getElementById('upiSettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveUPISettings();
            });
            
            // Restrictions form
            document.getElementById('restrictionsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveRestrictions();
            });
            
            // Order settings form
            document.getElementById('orderSettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveOrderSettings();
            });
            
            // Navigation links
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    if (page) {
                        navigateToPage(page);
                    }
                });
            });
            
            // Quick actions toolbar
            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.quick-action-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Category selection handlers
            document.getElementById('shopCategory').addEventListener('change', function() {
                const newCategoryInput = document.getElementById('newCategoryInput');
                if (this.value === 'other') {
                    newCategoryInput.style.display = 'block';
                } else {
                    newCategoryInput.style.display = 'none';
                }
            });
            
            document.getElementById('productCategory').addEventListener('change', function() {
                const customCategoryInput = document.getElementById('customCategoryInput');
                if (this.value === 'other') {
                    customCategoryInput.style.display = 'block';
                } else {
                    customCategoryInput.style.display = 'none';
                }
            });
            
            // Product search functionality
            const productSearch = document.getElementById('productSearch');
            if (productSearch) {
                productSearch.addEventListener('input', debounce(function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    if (!searchTerm) {
                        renderProducts();
                        return;
                    }
                    
                    const filteredProducts = products.filter(product => {
                        return (
                            product.name.toLowerCase().includes(searchTerm) ||
                            (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                            (product.category && product.category.toLowerCase().includes(searchTerm)) ||
                            (product.price && product.price.toString().includes(searchTerm))
                        );
                    });
                    
                    renderFilteredProducts(filteredProducts, searchTerm);
                }, 300));
            }
            
            // Product form submission
            document.getElementById('productForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProduct();
            });
            
            // Refund form submission
            document.getElementById('refundForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitRefund();
            });
            
            // Setup service options
            setupServiceOptions();
            
            // Setup checkbox event listeners for settings
            setupSettingsCheckboxes();
            
            // Initialize cloudinary widgets
            setTimeout(() => {
                if (typeof cloudinary !== 'undefined') {
                    initializeCloudinaryWidgets();
                }
            }, 1000);
            
            // Setup auto-save indicators
            setupAutoSaveIndicators();
            
            // Check for updates periodically
            setInterval(checkForUpdates, 60000); // Every minute
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
        });

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(this, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Render filtered products
        function renderFilteredProducts(filteredProducts, searchTerm) {
            const productsList = document.getElementById('productsList');
            
            if (filteredProducts.length === 0) {
                productsList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <i class="fas fa-search" style="font-size: 4rem; color: #ccc; margin-bottom: 1rem;"></i>
                        <h3 style="color: #666; margin-bottom: 1rem;">No Products Found</h3>
                        <p style="color: #999; margin-bottom: 1rem;">No products match your search: "${searchTerm}"</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-primary" onclick="document.getElementById('productSearch').value=''; loadProducts();">
                                <i class="fas fa-undo"></i> Clear Search
                            </button>
                            <button class="btn btn-outline" onclick="showAddProductModal()">
                                <i class="fas fa-plus"></i> Add New Product
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let productsHtml = '';
            filteredProducts.forEach((product) => {
                let stockClass = 'in-stock';
                let stockText = '';
                let stockIcon = 'check-circle';
                
                if (product.stock > 10) {
                    stockClass = 'in-stock';
                    stockText = `${product.stock} in stock`;
                    stockIcon = 'check-circle';
                } else if (product.stock > 0) {
                    stockClass = 'low-stock';
                    stockText = `Low stock (${product.stock})`;
                    stockIcon = 'exclamation-circle';
                } else {
                    stockClass = 'out-of-stock';
                    stockText = 'Out of stock';
                    stockIcon = 'times-circle';
                }

                let discountBadge = '';
                if (product.mrp && product.mrp > product.price) {
                    const discountPercent = Math.round(((product.mrp - product.price) / product.mrp) * 100);
                    if (discountPercent > 0) {
                        discountBadge = `<span class="product-discount">${discountPercent}% OFF</span>`;
                    }
                }

                const productImage = product.image || 'https://cdn-icons-png.flaticon.com/512/3148/3148829.png';

                const refundAvailable = product.refundAvailable !== undefined ? product.refundAvailable : true;
                const refundType = product.refundType || 'use_shop_default';
                const refundConditions = product.refundConditions || '';
                
                let refundBadge = '';
                if (!refundAvailable) {
                    refundBadge = '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">No Refund</span>';
                } else if (refundType === 'no_refund') {
                    refundBadge = '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">Non-Returnable</span>';
                } else {
                    refundBadge = '<span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">Refund Available</span>';
                }

                // Highlight search term in product name
                let productName = product.name;
                if (searchTerm) {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    productName = productName.replace(regex, '<mark>$1</mark>');
                }

                productsHtml += `
                    <div class="product-card">
                        <div class="product-image-container">
                            <img src="${productImage}" 
                                 alt="${product.name}" class="product-image">
                            <span class="product-badge">${product.category || 'Product'}</span>
                        </div>
                        <div class="product-details">
                            <h3 class="product-title">${productName} ${refundBadge}</h3>
                            
                            <div class="product-price-row">
                                <span class="product-price">‚Çπ${parseFloat(product.price || 0).toFixed(2)}</span>
                                ${product.mrp && product.mrp > product.price ? 
                                    `<span class="product-mrp">‚Çπ${parseFloat(product.mrp).toFixed(2)}</span>` : ''}
                                ${discountBadge}
                            </div>
                            
                            <div class="product-stock ${stockClass}">
                                <i class="fas fa-${stockIcon}"></i>
                                ${stockText}
                            </div>
                            
                            ${product.description ? `
                                <p style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                                    ${searchTerm ? highlightSearchTerm(product.description, searchTerm) : product.description.substring(0, 60)}
                                    ${product.description.length > 60 ? '...' : ''}
                                </p>
                            ` : ''}
                            
                            ${refundConditions ? `
                                <p style="color: #f39c12; font-size: 0.8rem; margin-top: 0.5rem;">
                                    <i class="fas fa-info-circle"></i> 
                                    ${searchTerm ? highlightSearchTerm(refundConditions, searchTerm) : refundConditions.substring(0, 50)}
                                    ${refundConditions.length > 50 ? '...' : ''}
                                </p>
                            ` : ''}
                            
                            <div class="product-actions">
                                <button class="btn-edit-product" onclick="editProduct('${product.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn-add-product" onclick="deleteProduct('${product.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            productsList.innerHTML = productsHtml;
            
            // Add search result count
            const searchHeader = document.querySelector('#productsPage h2');
            if (searchHeader) {
                const originalText = 'Product Management';
                searchHeader.innerHTML = `${originalText} <span class="badge bg-info">${filteredProducts.length} results for "${searchTerm}"</span>`;
            }
        }

        // Highlight search term in text
        function highlightSearchTerm(text, searchTerm) {
            if (!text || !searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.substring(0, 100).replace(regex, '<mark>$1</mark>');
        }

        // Setup settings checkboxes with proper event handling
        function setupSettingsCheckboxes() {
            // Payment method checkboxes
            const paymentCheckboxes = document.querySelectorAll('#upiSettingsForm .form-check-input');
            paymentCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const form = document.getElementById('upiSettingsForm');
                    form.classList.add('unsaved-changes');
                    showToast('Payment method changes detected. Click "Save Payment Settings" to save.', 'info');
                });
            });
            
            // Order settings checkboxes
            const orderCheckboxes = document.querySelectorAll('#orderSettingsForm .form-check-input');
            orderCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const form = document.getElementById('orderSettingsForm');
                    form.classList.add('unsaved-changes');
                    showToast('Order settings changes detected. Click "Save Order Settings" to save.', 'info');
                });
            });
            
            // Toggle switches
            const toggleSwitches = document.querySelectorAll('.toggle-switch input');
            toggleSwitches.forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const parentCard = this.closest('.settings-card');
                    if (parentCard) {
                        parentCard.classList.add('unsaved-changes');
                        showToast('Toggle setting changed. Click save button to apply.', 'info');
                    }
                });
            });
            
            // Form inputs in settings
            const settingInputs = document.querySelectorAll('.settings-card input, .settings-card select, .settings-card textarea');
            settingInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const parentCard = this.closest('.settings-card');
                    if (parentCard) {
                        parentCard.classList.add('unsaved-changes');
                        const saveBtn = parentCard.querySelector('.btn-primary');
                        if (saveBtn) {
                            saveBtn.classList.add('btn-warning');
                            saveBtn.classList.remove('btn-primary');
                        }
                    }
                });
            });
        }

        // Setup auto-save indicators
        function setupAutoSaveIndicators() {
            // Add CSS for unsaved changes indicator
            const style = document.createElement('style');
            style.textContent = `
                .settings-card.unsaved-changes {
                    border-left-color: #ffc107;
                    animation: pulse 2s infinite;
                }
                @keyframes pulse {
                    0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
                    70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
                }
                .btn-warning {
                    background: linear-gradient(135deg, #ffc107, #e0a800);
                    color: #212529;
                    border: none;
                }
                .btn-warning:hover {
                    background: linear-gradient(135deg, #e0a800, #d39e00);
                    transform: translateY(-2px);
                }
            `;
            document.head.appendChild(style);
            
            // Reset unsaved changes indicator when saved
            window.addEventListener('settingsSaved', function() {
                document.querySelectorAll('.settings-card').forEach(card => {
                    card.classList.remove('unsaved-changes');
                    const saveBtn = card.querySelector('.btn-primary, .btn-warning');
                    if (saveBtn) {
                        saveBtn.classList.remove('btn-warning');
                        saveBtn.classList.add('btn-primary');
                    }
                });
            });
        }

        // Check for updates periodically
        async function checkForUpdates() {
            if (!currentShop || !isOnline) return;
            
            try {
                // Check for new orders
                const pendingOrdersCount = orders.filter(o => o.status === 'pending').length;
                const newPendingOrders = await getNewPendingOrdersCount();
                
                if (newPendingOrders > pendingOrdersCount) {
                    showNotification('üì¶ New Orders', `You have ${newPendingOrders - pendingOrdersCount} new pending orders!`);
                    playNotificationSound();
                    loadOrders();
                }
                
                // Check for new refunds
                const pendingRefundsCount = refunds.filter(r => r.status === 'pending').length;
                const newPendingRefunds = await getNewPendingRefundsCount();
                
                if (newPendingRefunds > pendingRefundsCount) {
                    showNotification('üîÑ New Refunds', `You have ${newPendingRefunds - pendingRefundsCount} new refund requests!`);
                    loadRefunds();
                }
                
                // Update dashboard
                loadDashboardData();
                
            } catch (error) {
                console.log('Update check error:', error);
            }
        }

        async function getNewPendingOrdersCount() {
            try {
                const snapshot = await db.collection('orders')
                    .where('shopId', '==', currentShop.id)
                    .where('status', '==', 'pending')
                    .get();
                return snapshot.size;
            } catch (error) {
                return orders.filter(o => o.status === 'pending').length;
            }
        }

        async function getNewPendingRefundsCount() {
            try {
                const snapshot = await db.collection('refunds')
                    .where('shopId', '==', currentShop.id)
                    .where('status', '==', 'pending')
                    .get();
                return snapshot.size;
            } catch (error) {
                return refunds.filter(r => r.status === 'pending').length;
            }
        }

        // Setup keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + S to save current form
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    
                    // Check which page is active
                    const activePage = document.querySelector('.content-page.active');
                    if (!activePage) return;
                    
                    const pageId = activePage.id;
                    
                    switch(pageId) {
                        case 'productsPage':
                            const productModal = document.getElementById('productModal');
                            if (productModal.classList.contains('active')) {
                                saveProduct();
                            }
                            break;
                            
                        case 'settingsPage':
                            // Find which settings card has unsaved changes
                            const unsavedCard = document.querySelector('.settings-card.unsaved-changes');
                            if (unsavedCard) {
                                const saveBtn = unsavedCard.querySelector('.btn-primary, .btn-warning');
                                if (saveBtn) {
                                    saveBtn.click();
                                }
                            }
                            break;
                            
                        case 'profilePage':
                            document.getElementById('profileForm').dispatchEvent(new Event('submit'));
                            break;
                    }
                }
                
                // Escape key to close modals
                if (e.key === 'Escape') {
                    const activeModals = document.querySelectorAll('.modal.active, .order-details-fullscreen.active');
                    if (activeModals.length > 0) {
                        e.preventDefault();
                        activeModals.forEach(modal => {
                            const closeBtn = modal.querySelector('.close-modal');
                            if (closeBtn) closeBtn.click();
                        });
                    }
                }
                
                // F5 to refresh current page data
                if (e.key === 'F5') {
                    e.preventDefault();
                    const activePage = document.querySelector('.content-page.active');
                    if (activePage) {
                        const pageId = activePage.id;
                        switch(pageId) {
                            case 'dashboardPage':
                                loadDashboardData();
                                showToast('Dashboard refreshed', 'info');
                                break;
                            case 'productsPage':
                                loadProducts();
                                showToast('Products refreshed', 'info');
                                break;
                            case 'ordersPage':
                                loadOrders();
                                showToast('Orders refreshed', 'info');
                                break;
                            case 'refundsPage':
                                loadRefunds();
                                showToast('Refunds refreshed', 'info');
                                break;
                        }
                    }
                }
            });
        }

        // Helper function to trigger settings saved event
        function triggerSettingsSaved() {
            window.dispatchEvent(new Event('settingsSaved'));
        }

        // Modified save functions to trigger event
        const originalSaveUPISettings = saveUPISettings;
        saveUPISettings = async function() {
            await originalSaveUPISettings();
            triggerSettingsSaved();
        };

        const originalSaveCouponSettings = saveCouponSettings;
        saveCouponSettings = async function() {
            await originalSaveCouponSettings();
            triggerSettingsSaved();
        };

        const originalSaveRestrictions = saveRestrictions;
        saveRestrictions = async function() {
            await originalSaveRestrictions();
            triggerSettingsSaved();
        };

        const originalSaveOrderSettings = saveOrderSettings;
        saveOrderSettings = async function() {
            await originalSaveOrderSettings();
            triggerSettingsSaved();
        };

        // Initialize the app when page loads
        window.addEventListener('load', function() {
            // Check if user is returning to the page
            const returnToPage = localStorage.getItem('returnToPage');
            if (returnToPage && auth.currentUser) {
                navigateToPage(returnToPage);
                localStorage.removeItem('returnToPage');
            }
            
            // Save current page when navigating
            document.querySelectorAll('.nav-links a, .quick-action-btn').forEach(link => {
                link.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    if (page) {
                        localStorage.setItem('returnToPage', page);
                    }
                });
            });
            
            // Initialize the main app
            initApp();
        });

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Add offline capabilities
        function setupOfflineCapabilities() {
            // Cache important resources
            const cacheName = 'shopkeeper-panel-v1';
            const urlsToCache = [
                '/',
                'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css',
                'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css',
                'https://cdn-icons-png.flaticon.com/512/3082/3082383.png'
            ];

            self.addEventListener('install', function(event) {
                event.waitUntil(
                    caches.open(cacheName)
                        .then(function(cache) {
                            return cache.addAll(urlsToCache);
                        })
                );
            });

            self.addEventListener('fetch', function(event) {
                event.respondWith(
                    caches.match(event.request)
                        .then(function(response) {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        })
                );
            });
        }

        // Enhanced showToast function with persistence
        const originalShowToast = showToast;
        showToast = function(message, type = 'success', duration = 5000) {
            originalShowToast(message, type);
            
            // Store toast in localStorage for persistence
            const toasts = JSON.parse(localStorage.getItem('pendingToasts') || '[]');
            toasts.push({ message, type, timestamp: Date.now() });
            localStorage.setItem('pendingToasts', JSON.stringify(toasts.slice(-10))); // Keep last 10 toasts
        };

        // Show pending toasts on load
        window.addEventListener('load', function() {
            const pendingToasts = JSON.parse(localStorage.getItem('pendingToasts') || '[]');
            const currentTime = Date.now();
            
            pendingToasts.forEach(toast => {
                // Show toasts from last 5 minutes
                if (currentTime - toast.timestamp < 300000) {
                    setTimeout(() => {
                        originalShowToast(toast.message, toast.type);
                    }, 100);
                }
            });
            
            localStorage.removeItem('pendingToasts');
        });

        // Export shop data with more options
        async function exportShopDataWithOptions() {
            if (!currentShop) return;
            
            const exportType = prompt('Select export type:\n1. Full Data (All)\n2. Products Only\n3. Orders Only\n4. Refunds Only', '1');
            
            if (!exportType) return;
            
            try {
                showLoading(true);
                
                let exportData = {};
                
                switch(exportType) {
                    case '1':
                    case 'All':
                        exportData = {
                            shop: currentShop,
                            config: currentShopConfig,
                            products: products,
                            orders: orders,
                            refunds: refunds,
                            exportType: 'full',
                            exportDate: new Date().toISOString()
                        };
                        break;
                    case '2':
                    case 'Products':
                        exportData = {
                            shop: { id: currentShop.id, name: currentShop.name },
                            products: products,
                            exportType: 'products',
                            exportDate: new Date().toISOString()
                        };
                        break;
                    case '3':
                    case 'Orders':
                        exportData = {
                            shop: { id: currentShop.id, name: currentShop.name },
                            orders: orders,
                            exportType: 'orders',
                            exportDate: new Date().toISOString()
                        };
                        break;
                    case '4':
                    case 'Refunds':
                        exportData = {
                            shop: { id: currentShop.id, name: currentShop.name },
                            refunds: refunds,
                            exportType: 'refunds',
                            exportDate: new Date().toISOString()
                        };
                        break;
                    default:
                        showToast('Invalid export type selected', 'error');
                        return;
                }
                
                const jsonData = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `shop_export_${exportData.exportType}_${currentShop.id}_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSettingsSavedMessage(`‚úÖ ${exportData.exportType} data exported successfully!`);
                
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('Error exporting data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Replace original export function with enhanced version
        window.exportShopData = exportShopDataWithOptions;

        // Add confirmation before resetting settings
        const originalResetSettings = resetSettings;
        resetSettings = async function() {
            const confirmation = confirm('‚ö†Ô∏è WARNING: This will reset ALL settings to defaults.\n\nThis includes:\n‚Ä¢ Payment Settings\n‚Ä¢ Coupon Settings\n‚Ä¢ Shop Restrictions\n‚Ä¢ Order Management Settings\n\nAre you absolutely sure? This cannot be undone.');
            
            if (!confirmation) return;
            
            const secondConfirmation = confirm('FINAL WARNING: This action will delete all your custom settings.\n\nType "RESET" to confirm:');
            
            if (!secondConfirmation) return;
            
            const userInput = prompt('Please type "RESET" (all caps) to confirm:');
            if (userInput !== 'RESET') {
                showToast('Reset cancelled', 'info');
                return;
            }
            
            await originalResetSettings();
        };

        // Enhanced logout with confirmation
        const originalLogout = logout;
        logout = function() {
            if (confirm('Are you sure you want to logout?\n\nYou will need to login again to access your shop.')) {
                // Save current page for return
                const activePage = document.querySelector('.content-page.active');
                if (activePage) {
                    const pageId = activePage.id.replace('Page', '');
                    localStorage.setItem('lastPage', pageId);
                }
                
                originalLogout();
            }
        };

        // Auto-logout after 30 minutes of inactivity
        let logoutTimer;
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            logoutTimer = setTimeout(() => {
                if (auth.currentUser) {
                    if (confirm('You have been inactive for 30 minutes. Would you like to stay logged in?')) {
                        resetLogoutTimer();
                    } else {
                        logout();
                    }
                }
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Reset timer on user activity
        ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
            document.addEventListener(event, resetLogoutTimer);
        });

        // Initialize logout timer
        resetLogoutTimer();
    </script>
</body>
</html>
